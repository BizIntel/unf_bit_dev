
#Region СлужебныеПроцедурыИФункции

&НаКлиенте
Процедура ОбработкаГруппыПолей(Поле, Отказ)
	
	Если НЕ ПустаяСтрока(Поле.ИмяГруппыПолей) Тогда
		
		Отказ = Истина;
		ПоказатьПредупреждение(, Нстр("ru='Выбор групп не предусмотрен...'"));
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаПоляДополнительныхРеквизитов(Поле, Отказ)
	
	Если Поле.ИмяПоля = КэшЗначений.ИмяПоляДополнительныхРеквизитов Тогда
		
		Отказ = Истина;
		
		МаксимумДополнительныхРеквизитов = ЗагрузкаДанныхИзВнешнегоИсточникаПереопределяемый.МаксимумДополнительныхРеквизитовТабличногоДокумента();
		Если Параметры.НастройкиЗагрузкиДанных.ВыбранныеДополнительныеРеквизиты.Количество() >= МаксимумДополнительныхРеквизитов Тогда
			
			ТекстПредупреждения = НСтр("ru ='Большое количество дополнительных реквизитов в загрузке существенно замедляет процесс. 
			|Рекомендуется разделить загрузку на несколько итераций.'");
			
			ТекстЗаголовка = СтрШаблон(НСтр("ru ='Выбрано %1 реквизита'"), МаксимумДополнительныхРеквизитов);
			ПоказатьПредупреждение( , ТекстПредупреждения, 0, ТекстЗаголовка);
			Возврат;
			
		КонецЕсли;
		
		Элементы.Страницы.ТекущаяСтраница = Элементы.СтраницаДополнительныеРеквизиты;
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ВыполнитьОбязательныеДействияНаСервере(ИмяВыбранногоПоля)
	
	// План:
	//
	// Необходимо убедиться, что номер колонки уникален для выбранного поля (во всех др полях обнулить такой номер колонки)
	// Записать дерево значений для дальнейших взовов
	
	ДеревоПолей = ДанныеФормыВЗначение(ДеревоПолейЗагрузки, Тип("ДеревоЗначений"));
	
	ПараметрыОтбора = Новый Структура("НомерКолонки", КэшЗначений.НомерКолонки);
	
	НайденныеСтрокиДереваПолей = ДеревоПолей.Строки.НайтиСтроки(ПараметрыОтбора, Истина);
	Если НайденныеСтрокиДереваПолей.Количество() > 1 Тогда
		
		Для каждого СтрокаДереваПолей Из НайденныеСтрокиДереваПолей Цикл
			
			Если СтрокаДереваПолей.ИмяПоля <> ИмяВыбранногоПоля Тогда
				
				СтрокаДереваПолей.НомерКолонки = 0;
				СтрокаДереваПолей.НомерЦвета  = СтрокаДереваПолей.НомерЦветаОригинал;
				
			КонецЕсли;
			
		КонецЦикла;
		
	КонецЕсли;
	
	ПоместитьВоВременноеХранилище(ДеревоПолей, Параметры.НастройкиЗагрузкиДанных.АдресХраненияДереваПолей);
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьДеревоПолейЗагрузки(ДеревоПолей)
	
	ЗначениеВРеквизитФормы(ДеревоПолей, "ДеревоПолейЗагрузки");
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьДеревоДополнительныхРеквизитов()
	
	Если НЕ Параметры.НастройкиЗагрузкиДанных.Свойство("ОписаниеДополнительныхРеквизитов") Тогда
		
		Возврат;
		
	КонецЕсли;
	
	ДеревоДопРеквизитов = РеквизитФормыВЗначение("ДополнительныеРеквизиты");
	
	СтрокиВладельцев = ДеревоДопРеквизитов.Строки;
	Для каждого Описание Из Параметры.НастройкиЗагрузкиДанных.ОписаниеДополнительныхРеквизитов Цикл
		
		ДополнительныйРеквизит = Описание.Ключ;
		
		ВладелецДопРеквизита = СтрокиВладельцев.Найти(ДополнительныйРеквизит.НаборСвойств, "ВладелецДопРеквизита", Ложь);
		Если ВладелецДопРеквизита = Неопределено Тогда
			
			ВладелецДопРеквизита = СтрокиВладельцев.Добавить();
			ВладелецДопРеквизита.ВладелецДопРеквизита = ДополнительныйРеквизит.НаборСвойств;
			ВладелецДопРеквизита.Представление = ДополнительныйРеквизит.НаборСвойств.Наименование;
			ВладелецДопРеквизита.ЭлементДоступен = Истина; // для групп всегда Истина
			
		КонецЕсли;
		
		НоваяCтрока = ВладелецДопРеквизита.Строки.Добавить();
		НоваяCтрока.ДополнительныйРеквизит = Описание.Ключ;
		НоваяCтрока.Представление = Строка(Описание.Ключ.Наименование);
		НоваяCтрока.ЭлементДоступен = Истина;
		
	КонецЦикла;
	
	НоваяCтрока = СтрокиВладельцев.Добавить();
	НоваяCтрока.ДополнительныйРеквизит = ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения.ПустаяСсылка();
	НоваяCтрока.Представление = КэшЗначений.ПолеВозвратаСписок;
	НоваяCтрока.ЭлементДоступен = Истина;
	
	ЗначениеВРеквизитФормы(ДеревоДопРеквизитов, "ДополнительныеРеквизиты");
	
КонецПроцедуры

&НаКлиенте
Функция ДостигнутМаксимумПоКоличествуВыбранныхДополнительныхРеквизитов(КоллекцияЭлементовДополнительныхРеквизитов)
	
	МаксимумДополнительныхРеквизитов = ЗагрузкаДанныхИзВнешнегоИсточникаПереопределяемый.МаксимумДополнительныхРеквизитовТабличногоДокумента();
	
	Возврат КоллекцияЭлементовДополнительныхРеквизитов.Количество() >= МаксимумДополнительныхРеквизитов;
	
КонецФункции

&НаКлиенте
Функция ДобавитьПолеДополнительногоРеквизитаВДеревоПолей(КоллекцияЭлементовДополнительныхРеквизитов, СтрокаДопРеквизита)
	
	ПолеДополнительногоРеквизита = КоллекцияЭлементовДополнительныхРеквизитов.Добавить();
	
	ПолеДополнительногоРеквизита.ИмяГруппыПолей = "";
	ПолеДополнительногоРеквизита.ИмяПоля = Параметры.НастройкиЗагрузкиДанных.ОписаниеДополнительныхРеквизитов.Получить(СтрокаДопРеквизита.ДополнительныйРеквизит);
	ПолеДополнительногоРеквизита.ТипПолучаемогоЗначения = Неопределено;
	ПолеДополнительногоРеквизита.ПредставлениеПоля = СтрокаДопРеквизита.Представление;
	ПолеДополнительногоРеквизита.НомерЦвета = 3;
	ПолеДополнительногоРеквизита.НомерЦветаОригинал = 4;
	
	Возврат ПолеДополнительногоРеквизита;
	
КонецФункции

&НаКлиенте
Функция НайтиПолеДополнительногоРеквизитаВДеревоПолей(КоллекцияЭлементовДополнительныхРеквизитов, СтрокаДопРеквизита)
	
	Для каждого ПолеДополнительногоРеквизита Из КоллекцияЭлементовДополнительныхРеквизитов Цикл
		
		Если ПолеДополнительногоРеквизита.ИмяПоля = 
			Параметры.НастройкиЗагрузкиДанных.ОписаниеДополнительныхРеквизитов.Получить(СтрокаДопРеквизита.ДополнительныйРеквизит) Тогда
			
			Прервать;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат ПолеДополнительногоРеквизита;
	
КонецФункции

&НаКлиенте
Процедура ОбработатьВыборДополнительногоРеквизита(СтрокаДопРеквизита)
	
	Если СтрокаДопРеквизита.ПолучитьЭлементы().Количество() > 0 Тогда
		
		ПоказатьПредупреждение(, НСтр("ru ='Выбор групп не предусмотрен...'"));
		Возврат;
		
	КонецЕсли;
	
	ГруппаДопРеквизитов = Неопределено;
	
	ЭлементыПервогоУровня = ДеревоПолейЗагрузки.ПолучитьЭлементы();
	Для каждого СтрокаДерева Из ЭлементыПервогоУровня Цикл
		
		Если СтрокаДерева.ИмяПоля = КэшЗначений.ИмяГруппыДополнительныхРеквизитов Тогда
			
			ГруппаДопРеквизитов = СтрокаДерева;
			Прервать;
			
		КонецЕсли;
		
	КонецЦикла;
	
	КоллекцияЭлементовДополнительныхРеквизитов = ГруппаДопРеквизитов.ПолучитьЭлементы();
	Если Параметры.НастройкиЗагрузкиДанных.ВыбранныеДополнительныеРеквизиты.Получить(СтрокаДопРеквизита.ДополнительныйРеквизит) = Неопределено Тогда
		
		ПолеДополнительногоРеквизита = ДобавитьПолеДополнительногоРеквизитаВДеревоПолей(КоллекцияЭлементовДополнительныхРеквизитов, СтрокаДопРеквизита);
		
		Если ДостигнутМаксимумПоКоличествуВыбранныхДополнительныхРеквизитов(КоллекцияЭлементовДополнительныхРеквизитов) Тогда
			
			ГруппаДопРеквизитов.НомерЦвета = 3;
			
		КонецЕсли;
		
	Иначе
		
		ПолеДополнительногоРеквизита = НайтиПолеДополнительногоРеквизитаВДеревоПолей(КоллекцияЭлементовДополнительныхРеквизитов, СтрокаДопРеквизита);
		
	КонецЕсли;
	
	ЗапомнитьВыборИЗакрытьФорму(ПолеДополнительногоРеквизита, СтрокаДопРеквизита.ДополнительныйРеквизит);
	
КонецПроцедуры

&НаКлиенте
Процедура ЗапомнитьВыборИЗакрытьФорму(Поле, ДополнительныйРеквизит = Неопределено)
	
	Результат = Новый Структура;
	Результат.Вставить("Представление", Поле.ПредставлениеПоля);
	Результат.Вставить("Значение", 		Поле.ИмяПоля);
	Результат.Вставить("ДопРеквизит",	ДополнительныйРеквизит);
	
	Если Поле.НомерКолонки <> 0 Тогда
		
		Результат.Вставить("ОтменитьВыборВКолонке", Поле.НомерКолонки);
		
	КонецЕсли;
	
	ВыбралиСамиСебя = (Поле.НомерКолонки = КэшЗначений.НомерКолонки);
	Если НЕ ПустаяСтрока(Поле.ИмяПоля) Тогда
		
		Поле.НомерКолонки = ?(ВыбралиСамиСебя, 0, КэшЗначений.НомерКолонки);
		Поле.НомерЦвета = ?(ВыбралиСамиСебя, Поле.НомерЦветаОригинал, 3);
		
	КонецЕсли;
	
	ВыполнитьОбязательныеДействияНаСервере(Поле.ИмяПоля);
	
	Закрыть(Результат);
	
КонецПроцедуры

#EndRegion

#Region СобытияФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Перем ЗаголовокКолонки;
	
	Если Параметры.Свойство("АвтоТест") Тогда // Возврат при получении формы для анализа.
		Возврат;
	КонецЕсли;
	
	Если Параметры.Свойство("ЗаголовокКолонки", ЗаголовокКолонки) Тогда
		
		ЭтаФорма.Заголовок = НСтр("ru ='Выбор поля'") + ?(ПустаяСтрока(ЗаголовокКолонки), "", ": " + СокрЛП(ЗаголовокКолонки));
		
	КонецЕсли;
	
	КэшЗначений = Новый Структура;
	КэшЗначений.Вставить("ИмяПоляДополнительныхРеквизитов", ЗагрузкаДанныхИзВнешнегоИсточника.ИмяПоляДобавленияДополнительныхРеквизитов());
	КэшЗначений.Вставить("НомерКолонки", Параметры.НомерКолонки);
	КэшЗначений.Вставить("ПолеВозвратаСписок", НСтр("ru ='Назад к списку реквизитов'"));
	КэшЗначений.Вставить("ИмяГруппыДополнительныхРеквизитов", ЗагрузкаДанныхИзВнешнегоИсточника.ИмяПоляДобавленияДополнительныхРеквизитов());
	
	ДеревоПолей = ПолучитьИзВременногоХранилища(Параметры.НастройкиЗагрузкиДанных.АдресХраненияДереваПолей);
	ЗаполнитьДеревоПолейЗагрузки(ДеревоПолей);
	
	ЗаполнитьДеревоДополнительныхРеквизитов();
	
КонецПроцедуры

#EndRegion

#Region СобытияРеквизитовФормы

&НаКлиенте
Процедура ТаблицаПолейЗагрузкиВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	Отказ = Ложь;
	СтандартнаяОбработка = Ложь;
	
	Поле = ДеревоПолейЗагрузки.НайтиПоИдентификатору(ВыбраннаяСтрока);
	
	ОбработкаГруппыПолей(Поле, Отказ);
	ОбработкаПоляДополнительныхРеквизитов(Поле, Отказ);
	
	Если НЕ Отказ Тогда
		
		ЗапомнитьВыборИЗакрытьФорму(Поле);
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ДополнительныеРеквизитыВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	СтрокаДопРеквизита = ДополнительныеРеквизиты.НайтиПоИдентификатору(ВыбраннаяСтрока);
	Если СтрокаДопРеквизита.Представление = КэшЗначений.ПолеВозвратаСписок Тогда
		
		Элементы.Страницы.ТекущаяСтраница = Элементы.СтраницаПоля;
		
	Иначе
		
		ОбработатьВыборДополнительногоРеквизита(СтрокаДопРеквизита);
		
	КонецЕсли;
	
КонецПроцедуры

#EndRegion