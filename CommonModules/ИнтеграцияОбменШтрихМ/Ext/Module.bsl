
// См. описание этой же процедуры в общем модуле
// ОчередьЗаданийПереопределяемый.
//
Процедура ПриОпределенииПсевдонимовОбработчиков(СоответствиеИменПсевдонимам) Экспорт
	
	СоответствиеИменПсевдонимам.Вставить(Метаданные.РегламентныеЗадания.ОбменДаннымиССерверомШтрихМ.ИмяМетода);
	СоответствиеИменПсевдонимам.Вставить(Метаданные.РегламентныеЗадания.ОбменТоваромССерверомШтрихМ.ИмяМетода);
	
	
КонецПроцедуры

// Возвращает реквизиты кассы ШтрихМ из регистра настройки кассы
//
Функция ПолучитьРеквизитыКассыШтрихМ(КассаККМ) Экспорт
	
	ДанныеКассы = Новый Структура(
	"ДатаНачалаЗапросаЧеков,
	|ДатаОкончанияЗапросаЧеков,
	|ЗапроситьЧекиНаСервереШтрихМ,
	|ЗарегистрированНаСервереШтрихМ,
	|ЗарегистрироватьТоварыНаСервереШтрихМ,
	|ИдентификаторОбластиНаСервереШтрихМ,
	|ОчиститьТоварыНаСервереШтрихМ,
	|ПроверитьРегистрациюТоваровНаСервереШтрихМ,
	|РегистрационныйНомер,
	|СерийныйНомер,
	|Токен,
	|ИдентификаторТарификации,
	|ПрайсЛист,
	|СообщениеПриРегистрации");
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	НастройкиКассыШтрихМ.ДатаНачалаЗапросаЧеков,
	|	НастройкиКассыШтрихМ.ДатаОкончанияЗапросаЧеков,
	|	НастройкиКассыШтрихМ.ЗапроситьЧекиНаСервереШтрихМ,
	|	НастройкиКассыШтрихМ.ЗарегистрированНаСервереШтрихМ,
	|	НастройкиКассыШтрихМ.ЗарегистрироватьТоварыНаСервереШтрихМ,
	|	НастройкиКассыШтрихМ.ИдентификаторОбластиНаСервереШтрихМ,
	|	НастройкиКассыШтрихМ.ОчиститьТоварыНаСервереШтрихМ,
	|	НастройкиКассыШтрихМ.ПроверитьРегистрациюТоваровНаСервереШтрихМ,
	|	НастройкиКассыШтрихМ.РегистрационныйНомер,
	|	НастройкиКассыШтрихМ.СерийныйНомер,
	|	НастройкиКассыШтрихМ.Токен,
	|	НастройкиКассыШтрихМ.ИдентификаторТарификации,
	|	НастройкиКассыШтрихМ.СообщениеПриРегистрации,
	|	НастройкиКассыШтрихМ.ПрайсЛист
	|ИЗ
	|	РегистрСведений.НастройкиКассыШтрихМ КАК НастройкиКассыШтрихМ
	|ГДЕ
	|	НастройкиКассыШтрихМ.КассаККМ = &КассаККМ");
	
	Запрос.УстановитьПараметр("КассаККМ", КассаККМ);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		ЗаполнитьЗначенияСвойств(ДанныеКассы, Выборка);
	КонецЕсли;
	
	Возврат ДанныеКассы;
	
КонецФункции

// Функция возвращает кассу по её регистрационному номеру из регистра настроек касс
//
// Параметры:
//  РегистрационныйНомер  - Строка - Регистрационный номер кассы
//
// Возвращаемое значение:
//   СправочникСсылка.КассыККМ   - Искомая по регномеру касса
//
Функция ПолучитьКассуПоРегистрационномуНомеру(РегистрационныйНомер)Экспорт
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	НастройкиКассыШтрихМ.КассаККМ
	|ИЗ
	|	РегистрСведений.НастройкиКассыШтрихМ КАК НастройкиКассыШтрихМ
	|ГДЕ
	|	НастройкиКассыШтрихМ.РегистрационныйНомер = &РегистрационныйНомер");
	
	Запрос.УстановитьПараметр("РегистрационныйНомер", СокрЛП(РегистрационныйНомер));
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		Возврат Выборка.КассаККМ;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции // ПолучитьКассуПоРегистрационномуНомеру()

// Функция возвращает кассу по её регистрационному номеру из регистра настроек касс
//
// Параметры:
//  РегистрационныйНомер  - Строка - Регистрационный номер кассы
//
// Возвращаемое значение:
//   СправочникСсылка.КассыККМ   - Искомая по регномеру касса
//
Функция ПолучитьКассуПоИдентификаторуЛицензии(Лицензия)Экспорт
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	НастройкиКассыШтрихМ.КассаККМ
	|ИЗ
	|	РегистрСведений.НастройкиКассыШтрихМ КАК НастройкиКассыШтрихМ
	|ГДЕ
	|	НастройкиКассыШтрихМ.ИдентификаторТарификации = &Лицензия");
	
	Запрос.УстановитьПараметр("Лицензия", СокрЛП(Лицензия));
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		Возврат Выборка.КассаККМ;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции // ПолучитьКассуПоРегистрационномуНомеру()

Процедура ВойтиВОбластьДанныхНаСервере(Знач ОбластьДанных) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	ОбщегоНазначения.УстановитьРазделениеСеанса(Истина, ОбластьДанных);
	
	НачатьТранзакцию();
	
	Попытка
		
		КлючОбласти = РаботаВМоделиСервиса.СоздатьКлючЗаписиРегистраСведенийВспомогательныхДанных(
			РегистрыСведений.ОбластиДанных,
			Новый Структура(РаботаВМоделиСервиса.РазделительВспомогательныхДанных(), ОбластьДанных));
		ЗаблокироватьДанныеДляРедактирования(КлючОбласти);
		
		Блокировка = Новый БлокировкаДанных;
		Элемент = Блокировка.Добавить("РегистрСведений.ОбластиДанных");
		Элемент.УстановитьЗначение("ОбластьДанныхВспомогательныеДанные", ОбластьДанных);
		Элемент.Режим = РежимБлокировкиДанных.Разделяемый;
		Блокировка.Заблокировать();
		
		МенеджерЗаписи = РегистрыСведений.ОбластиДанных.СоздатьМенеджерЗаписи();
		МенеджерЗаписи.ОбластьДанныхВспомогательныеДанные = ОбластьДанных;
		МенеджерЗаписи.Прочитать();
		Если Не МенеджерЗаписи.Выбран() Тогда
			МенеджерЗаписи.ОбластьДанныхВспомогательныеДанные = ОбластьДанных;
			МенеджерЗаписи.Статус = Перечисления.СтатусыОбластейДанных.Используется;
			МенеджерЗаписи.Записать();
		КонецЕсли;
		РазблокироватьДанныеДляРедактирования(КлючОбласти);
		
		ЗафиксироватьТранзакцию();
	Исключение
		ОтменитьТранзакцию();
		ВызватьИсключение;
	КонецПопытки;
КонецПроцедуры

Процедура ВыйтиИзОбластиДанныхНаСервере() Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	ОбщегоНазначения.УстановитьРазделениеСеанса(Ложь);
КонецПроцедуры

Функция ЗагрузитьДанныеОбменаИз1СКасса(ИмяФайла) Экспорт
	
	
	ЧтениеXML = Новый ЧтениеXML;
	ЧтениеXML.ОткрытьФайл(ИмяФайла);
	ЧтениеXML.Прочитать(); // Message
	ЧтениеXML.Прочитать(); // Header
	
	Header = ФабрикаXDTO.ПрочитатьXML(ЧтениеXML, ФабрикаXDTO.Тип("http://www.1c.ru/SSL/Exchange/Message", "Header"));
	Если ЧтениеXML.ТипУзла <> ТипУзлаXML.НачалоЭлемента
		Или ЧтениеXML.ЛокальноеИмя <> "Body" Тогда
		
		ЗаписьЖурналаРегистрации(
			"Загрузка1СКасса.Загрузка1СКасса",
			УровеньЖурналаРегистрации.Ошибка,,, 
			НСтр("ru='Ошибка чтения сообщения загрузки. Неверный формат сообщения.'"));
			
		Возврат Ложь;
	КонецЕсли;
	
	ФорматОбмена = РазложитьФорматОбмена(Header.Format);
	ВерсияФорматаДляЗагрузки = ФорматОбмена.Версия;
	КомпонентыОбмена = КомпонентыОбмена("Получение", ВерсияФорматаДляЗагрузки);
	КомпонентыОбмена.XMLСхема = Header.Format;

	
	ЧтениеXML.Прочитать(); // Body
	КомпонентыОбмена.Вставить("ФайлОбмена", ЧтениеXML);
	
	ОбменДаннымиXDTOСервер.ПроизвестиЧтениеДанных(КомпонентыОбмена);
	
	ЧтениеXML.Закрыть();
	Если КомпонентыОбмена.ФлагОшибки Тогда
				ЗаписьЖурналаРегистрации(
			"Загрузка1СКасса.Загрузка1СКасса",
			УровеньЖурналаРегистрации.Ошибка,,, 
			 НСтр("ru='В ходе выполнения операции возникли ошибки'") + ": " + Символы.ПС + КомпонентыОбмена.СтрокаСообщенияОбОшибке);
	КонецЕсли;
	
КонецФункции

Функция РазложитьФорматОбмена(Знач ФорматОбмена)
	
	Результат = Новый Структура("БазовыйФормат, Версия");
	
	ЭлементыФормата = СтрРазделить(ФорматОбмена, "/");
	
	Если ЭлементыФормата.Количество() = 0 Тогда
		ВызватьИсключение СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = 'Неканоническое имя формата обмена <%1>'"), ФорматОбмена);
	КонецЕсли;
	
	Результат.Версия = ЭлементыФормата[ЭлементыФормата.ВГраница()];
	
	Версии = СтрРазделить(Результат.Версия, ".");
	
	Если Версии.Количество() = 0 Тогда
		ВызватьИсключение СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = 'Неканоническое представление версии формата обмена: <%1>.'"), Результат.Версия);
	КонецЕсли;
	
	ЭлементыФормата.Удалить(ЭлементыФормата.ВГраница());
	
	Результат.БазовыйФормат = СтрСоединить(ЭлементыФормата, "/");
	
	Возврат Результат;
КонецФункции

// Выполняет подготовку структуры КомпонентыОбмена.
// Параметры:
//   НаправлениеОбмена - Строка - Отправка или Получение.
//   ВерсияФорматаОбменаПриЗагрузке - Строка - Версия формата, которая должна применяться при загрузке данных.
//
// Возвращаемое значение:
//   Структура - Компоненты обмена.
//
Функция КомпонентыОбмена(НаправлениеОбмена, ВерсияФорматаОбменаПриЗагрузке = "") Экспорт
	
	КомпонентыОбмена = ОбменДаннымиXDTOСервер.ИнициализироватьКомпонентыОбмена(НаправлениеОбмена);
	ТекВерсияФормата = "1.4";
	КомпонентыОбмена.ЭтоОбменЧерезПланОбмена = Ложь;
	
	КомпонентыОбмена.КлючСообщенияЖурналаРегистрации = НСтр("ru = 'Перенос данных через буфер обмена'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
	КомпонентыОбмена.ВерсияФорматаОбмена = "1.4";
	КомпонентыОбмена.XMLСхема = "http://v8.1c.ru/edi/edi_stnd/EnterpriseData/" + ТекВерсияФормата;
	
	РежимРаботы = ОбщегоНазначенияПовтИсп.РежимРаботыПрограммы();
	РежимРаботы = Новый ФиксированнаяСтруктура(РежимРаботы);
	МенеджерОбменаВнутренний = Истина;
	
	Если МенеджерОбменаВнутренний Тогда
		ВерсииФорматаОбмена = Новый Соответствие;
		ОбменДаннымиПереопределяемый.ПриПолученииДоступныхВерсийФормата(ВерсииФорматаОбмена);
		КомпонентыОбмена.МенеджерОбмена = ВерсииФорматаОбмена.Получить(ТекВерсияФормата);
		Если КомпонентыОбмена.МенеджерОбмена = Неопределено Тогда
			ВызватьИсключение СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(НСтр("ru = 'Не поддерживается версия формата обмена: <%1>.'"), ТекВерсияФормата);
		КонецЕсли;
	КонецЕсли;
	
	ОбменДаннымиXDTOСервер.ИнициализироватьТаблицыПравилОбмена(КомпонентыОбмена);
	
	Возврат КомпонентыОбмена;
	
КонецФункции

Функция ПолучитьПрайсЛистПоУмолчанию(Организация) Экспорт
	Запрос = Новый Запрос(
	"ВЫБРАТЬ ПрайсЛист.Ссылка КАК ПрайсЛист
	|ИЗ Справочник.ПрайсЛисты КАК ПрайсЛист
	|ГДЕ ПрайсЛист.Наименование = ""Прайс-лист кассы Штрих-М""");

	Выборка = Запрос.Выполнить().Выбрать();

	Если Выборка.Следующий() Тогда
		Возврат Выборка.ПрайсЛист;
	Иначе
		НовыйПрайсЛист = Справочники.ПрайсЛисты.СоздатьЭлемент();
		НовыйПрайсЛист.Наименование = "Прайс-лист кассы Штрих-М";
		НовыйПрайсЛист.Валюта = Константы.НациональнаяВалюта.Получить();
		НовыйПрайсЛист.Организация = Организация;
		НовыйПрайсЛист.ИерархияСодержимого = Перечисления.ИерархияПрайсЛистов.ИерархияНоменклатуры;
		НовыйПрайсЛист.ПечатьПрайсЛиста = Перечисления.ВариантыПечатиПрайсЛиста.Полотно;
		СтрокаВидаЦены = НовыйПрайсЛист.ВидыЦен.Добавить();
		СтрокаВидаЦены.ВидЦен = РозничныйВидЦены(Неопределено);
		
		НоваяСтрокаПредставления = НовыйПрайсЛист.ПредставлениеНоменклатуры.Добавить();
		НоваяСтрокаПредставления.Использование = Истина;
		НоваяСтрокаПредставления.РеквизитНоменклатуры = "Артикул";
		НоваяСтрокаПредставления.РеквизитПредставление = "Артикул";
		
		НоваяСтрокаПредставления = НовыйПрайсЛист.ПредставлениеНоменклатуры.Добавить();
		НоваяСтрокаПредставления.Использование = Истина;
		НоваяСтрокаПредставления.РеквизитНоменклатуры = "Наименование";
		НоваяСтрокаПредставления.РеквизитПредставление = "Наименование";
		
		НовыйПрайсЛист.Записать();
		
		Возврат НовыйПрайсЛист.Ссылка;
		
	КонецЕсли;
КонецФункции

Функция РозничныйВидЦены(КассовыйАппарат) Экспорт
	
	Если КассовыйАппарат <> Неопределено Тогда
		ПрайсЛистКассы = ПолучитьРеквизитыКассыШтрихМ(КассовыйАппарат).ПрайсЛист;
		
				// Определение вида цены прайслиста
		Запрос = Новый Запрос(
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	ПрайсЛистыВидыЦен.ВидЦен
		|ИЗ
		|	Справочник.ПрайсЛисты.ВидыЦен КАК ПрайсЛистыВидыЦен
		|ГДЕ
		|	ПрайсЛистыВидыЦен.Ссылка = &Ссылка");
		
		Запрос.УстановитьПараметр("Ссылка", ПрайсЛистКассы);
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		Если Выборка.Следующий() Тогда
			ВидЦены = Выборка.ВидЦен;
		Иначе
			ВидЦены = ИнтеграцияОбменШтрихМ.РозничныйВидЦены();
		КонецЕсли;
		
		Возврат ВидЦены;
		
	КонецЕсли;
	
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ВидыЦен.Ссылка КАК ВидЦен
	|ИЗ
	|	Справочник.ВидыЦен КАК ВидыЦен
	|ГДЕ
	|	(ВидыЦен.Наименование = ""Розничные""
	|			ИЛИ ВидыЦен.Наименование = ""Розничная""
	|			ИЛИ ВидыЦен.Наименование = ""Розничная цена"")");
	
	// найден вид цен с названием розничные, розничная
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		ВидЦеныКассы = Выборка.ВидЦен;
		Возврат ВидЦеныКассы;
	КонецЕсли;
	
	
	РозничнаяЦена = Справочники.ВидыЦен.СоздатьЭлемент();
	РозничнаяЦена.Наименование = "Розничная";
	РозничнаяЦена.ВалютаЦены = Константы.НациональнаяВалюта.Получить();
	РозничнаяЦена.ЦенаВключаетНДС = Истина;
	РозничнаяЦена.ТипВидаЦен = Перечисления.ТипыВидовЦен.Статический;
	РозничнаяЦена.ПорядокОкругления = 1;
	РозничнаяЦена.ФорматЦены = "ЧЦ=15; ЧДЦ=2";
	РозничнаяЦена.ИдентификаторФормул = "Розничная";
	
	РозничнаяЦена.Записать();
	
	Возврат РозничнаяЦена.Ссылка;
	
КонецФункции

Функция ВключитьРозничныеПродажи() Экспорт
	
	Константы.ФункциональнаяОпцияУчетРозничныхПродаж.Установить(Истина);
	Константы.ФункциональнаяОпцияЛегкиеРозничныеПродажи.Установить(Истина);
	Константы.КонтролироватьОстаткиПриПробитииЧековККМ.Установить(Ложь);
	
КонецФункции