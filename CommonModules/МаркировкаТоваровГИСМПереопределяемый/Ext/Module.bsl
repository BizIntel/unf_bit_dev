#Область ПрограммныйИнтерфейс

#Область МаркировкаТоваров

// Заполняет GTINВСтроках
//
// Параметры:
//  ДокументОбъект - ДокументОбъект. - Документ для заполнения GTIN
//
Процедура ЗаполнитьGTINВСтроках(ДокументОбъект) Экспорт
	
	
КонецПроцедуры

#Область ОбработчикиСобытийМодуляОбъекта

// Инициализировать документ
//
// Параметры:
//  ДокументОбъект	 - ДокументОбъект.* - обрабатываемый документ.
//  ДанныеЗаполнения - Структура - данные заполнения.
//
Процедура ИнициализироватьДокументМаркировкаТоваров(ДокументОбъект, ДанныеЗаполнения = Неопределено) Экспорт
	
	
КонецПроцедуры

// Обработка заполнения маркировка товаров
//
// Параметры:
//  ДанныеЗаполнения	 - Структура - данные заполнения.
//  СтандартнаяОбработка - Булево - стандартная обработка.
//  ДокументОбъект	 - ДокументОбъект.* - обрабатываемый документ.
//
Процедура ОбработкаЗаполненияМаркировкаТоваров(ДанныеЗаполнения, СтандартнаяОбработка, ДокументОбъект) Экспорт
	
	ДокументОбъект.Ответственный = Пользователи.ТекущийПользователь();
	Если НЕ ЗначениеЗаполнено(ДокументОбъект.Организация) Тогда
		ДокументОбъект.Организация   = УправлениеНебольшойФирмойПовтИсп.ПолучитьЗначениеПоУмолчаниюПользователя(ДокументОбъект.Ответственный, "ОсновнаяОрганизация");
	КонецЕсли;
	
	
КонецПроцедуры

// Обработка проверки заполнения маркировка товаров
//
// Параметры:
//  Отказ							 - Булево - Отказ.
//  ПроверяемыеРеквизиты			 - Массив - массив проверяемых реквизитов.
//  МассивНепроверяемыхРеквизитов	 - Массив - массив непроверяемых реквизитов.
//  ДокументОбъект	 				 - ДокументОбъект.* - обрабатываемый документ.
//
Процедура ОбработкаПроверкиЗаполненияМаркировкаТоваров(Отказ, ПроверяемыеРеквизиты, МассивНепроверяемыхРеквизитов, ДокументОбъект) Экспорт
	
	
КонецПроцедуры

// Перед записью маркировка товаров
//
// Параметры:
//  Отказ							 - Булево - Отказ.
//  РежимЗаписи						 - РежимЗаписи - Режим записи документа.
//  РежимПроведения	 				 - РежимПроведения - Режим проведения документа.
//  ДокументОбъект	 				 - ДокументОбъект.* - обрабатываемый документ.
//
Процедура ПередЗаписьюМаркировкаТоваров(Отказ, РежимЗаписи, РежимПроведения, ДокументОбъект) Экспорт
	
	НомераКиз = ДокументОбъект.Серии.Выгрузить();
	НоменклатураКиЗ = ДокументОбъект.Товары.Выгрузить();
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	тзНомераКиз.КлючСвязи КАК КлючСвязи,
	|	тзНомераКиз.Серия
	|ПОМЕСТИТЬ втТаблицаСерий
	|ИЗ
	|	&НомераКиз КАК тзНомераКиз
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	тзНомераКиз.КлючСвязи КАК КлючСвязи,
	|	СерийныеНомера.RFIDTID КАК RFIDTID,
	|	СерийныеНомера.RFIDUser КАК RFIDUser,
	|	СерийныеНомера.RFIDEPC КАК RFIDEPC,
	|	СерийныеНомера.EPCGTIN КАК EPCGTIN,
	|	СерийныеНомера.НомерГИСМ КАК НомерГИСМ,
	|	СерийныеНомера.НомерКиЗГИСМ КАК НомерКиЗГИСМ
	|ПОМЕСТИТЬ втНомераКиз
	|ИЗ
	|	втТаблицаСерий КАК тзНомераКиз
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.СерийныеНомера КАК СерийныеНомера
	|		ПО тзНомераКиз.Серия = СерийныеНомера.Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	тзНомеклатураКиз.НоменклатураКИЗ КАК НоменклатураКИЗ,
	|	тзНомеклатураКиз.ХарактеристикаКИЗ КАК ХарактеристикаКиз,
	|	тзНомеклатураКиз.КлючСвязи КАК КлючСвязи,
	|	тзНомеклатураКиз.GTIN КАК GTIN
	|ПОМЕСТИТЬ втНоменклатураКиз
	|ИЗ
	|	&НоменклатураКиз КАК тзНомеклатураКиз
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	втНоменклатураКиз.НоменклатураКиЗ КАК Владелец,
	|	
	|	СерийныеНомера.Ссылка,
	|	втНомераКиз.КлючСвязи,
	|	втНомераКиз.RFIDTID,
	|	втНомераКиз.RFIDUser,
	|	втНомераКиз.RFIDEPC,
	|	втНомераКиз.EPCGTIN,
	|	втНомераКиз.НомерГИСМ,
	|	втНомераКиз.НомерКиЗГИСМ,
	|	втНомераКиз.НомерКиЗГИСМ Как Наименование,
	|	втНоменклатураКИЗ.НоменклатураКИЗ Как Номенклатура,
	|	втНоменклатураКИЗ.ХарактеристикаКИЗ Как Характеристика,
	|	втНоменклатураКИЗ.GTIN Как GTIN
	|ИЗ
	|	втНоменклатураКиз КАК втНоменклатураКиз
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ втНомераКиз КАК втНомераКиз
	|		ПО втНоменклатураКиз.КлючСвязи = втНомераКиз.КлючСвязи
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СерийныеНомера КАК СерийныеНомера
	|		ПО втНоменклатураКиз.НоменклатураКИЗ = СерийныеНомера.Владелец
	|			И (втНомераКиз.НомерКиЗГИСМ = СерийныеНомера.НомерКиЗГИСМ)");
	
	Запрос.УстановитьПараметр("НомераКиз", НомераКИЗ);
	Запрос.УстановитьПараметр("НоменклатураКиЗ",НоменклатураКиЗ);
	
	
	Пакет = Запрос.ВыполнитьПакет();
	Выборка = Пакет[3].Выбрать();
	ДокументОбъект.СерииКиЗ.Очистить();
	
	Пока Выборка.Следующий() Цикл
		
		Серия = Неопределено;
		
		// если в номенклатуре КИЗ уже существует такая метка, значит используем ее
		Если ЗначениеЗаполнено(Выборка.Ссылка) Тогда
			Серия = Выборка.Ссылка;
		Иначе // создаем новую метку 
			
			Серия = Справочники.СерийныеНомера.СоздатьЭлемент();
			ЗаполнитьЗначенияСвойств(Серия, Выборка);
			Серия.Записать();
			
		КонецЕсли;
		
		Строка = ДокументОбъект.СерииКиЗ.Добавить();
		Строка.КлючСвязи = Выборка.КлючСвязи;
		Строка.Номенклатура = Выборка.Номенклатура;
		Строка.Характеристика = Выборка.Характеристика;
		Строка.GTIN = Выборка.GTIN;
		Строка.Количество = 1;
		
		Строка.Серия = Серия;
		
	КонецЦикла;
	
	
КонецПроцедуры

// При копировании маркировка товаров
//
// Параметры:
//  ОбъектКопирования	 - см. описание параметра в синтаксис-помощнике к обработчику "ПриКопировании"
//  ДокументОбъект	 	 - ДокументОбъект.* - обрабатываемый документ.
//
Процедура ПриКопированииМаркировкаТоваров(ОбъектКопирования, ДокументОбъект) Экспорт
	
	
КонецПроцедуры

// Обработка проведения маркировка товаров
//
// Параметры:
//  Отказ			 - Булево - Отказ.
//  РежимПроведения	 				 - РежимПроведения - Режим проведения документа.
//  ДокументОбъект	 				 - ДокументОбъект.* - обрабатываемый документ.
//
Процедура ОбработкаПроведенияМаркировкаТоваров(Отказ, РежимПроведения, ДокументОбъект) Экспорт
	
	ИнтеграцияГИСМУНФ.ОбработкаПроведенияМаркировкаТоваров(Отказ, РежимПроведения, ДокументОбъект);
	
КонецПроцедуры

// Обработка удаления проведения маркировка товаров
//
// Параметры:
//  Отказ			 - Булево - Отказ.
//  ДокументОбъект	 - ДокументОбъект.* - обрабатываемый документ.
//
Процедура ОбработкаУдаленияПроведенияМаркировкаТоваров(Отказ, ДокументОбъект) Экспорт
	
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

#Область ПеремаркировкаТоваров

#Область ОбработчикиСобытийМодуляОбъекта

// Инициализировать документ
//
// Параметры:
//  ДокументОбъект	 - ДокументОбъект.* - обрабатываемый документ.
//  ДанныеЗаполнения - Структура - данные заполнения.
//
Процедура ИнициализироватьДокументПеремаркировкаТоваров(ДокументОбъект, ДанныеЗаполнения = Неопределено) Экспорт
	
	
КонецПроцедуры

// Обработка проверки заполнения перемаркировка товаров
//
// Параметры:
//  Отказ							 - Булево - Отказ.
//  ПроверяемыеРеквизиты			 - Массив - массив проверяемых реквизитов.
//  МассивНепроверяемыхРеквизитов	 - Массив - массив непроверяемых реквизитов.
//  ДокументОбъект	 				 - ДокументОбъект.* - обрабатываемый документ.
//
Процедура ОбработкаЗаполненияПеремаркировкаТоваров(ДанныеЗаполнения, СтандартнаяОбработка, ДокументОбъект) Экспорт
	
	ДокументОбъект.Ответственный = Пользователи.ТекущийПользователь();
	Если НЕ ЗначениеЗаполнено(ДокументОбъект.Организация) Тогда
		ДокументОбъект.Организация   = УправлениеНебольшойФирмойПовтИсп.ПолучитьЗначениеПоУмолчаниюПользователя(ДокументОбъект.Ответственный, "ОсновнаяОрганизация");
	КонецЕсли;
	
КонецПроцедуры

// Обработка проверки заполнения перемаркировка товаров
//
// Параметры:
//  Отказ							 - Булево - Отказ.
//  ПроверяемыеРеквизиты			 - Массив - массив проверяемых реквизитов.
//  МассивНепроверяемыхРеквизитов	 - Массив - массив непроверяемых реквизитов.
//  ДокументОбъект	 				 - ДокументОбъект.* - обрабатываемый документ.
//
Процедура ОбработкаПроверкиЗаполненияПеремаркировкаТоваров(Отказ, ПроверяемыеРеквизиты, МассивНепроверяемыхРеквизитов, ДокументОбъект) Экспорт
	
	
КонецПроцедуры

// Перед записью перемаркировка товаров
//
// Параметры:
//  Отказ							 - Булево - Отказ.
//  РежимЗаписи						 - РежимЗаписи - Режим записи документа.
//  РежимПроведения	 				 - РежимПроведения - Режим проведения документа.
//  ДокументОбъект	 				 - ДокументОбъект.* - обрабатываемый документ.
//
Процедура ПередЗаписьюПеремаркировкаТоваров(Отказ, РежимЗаписи, РежимПроведения, ДокументОбъект) Экспорт
	
	
КонецПроцедуры

// При копировании перемаркировка товаров
//
// Параметры:
//  ОбъектКопирования	 - см. описание параметра в синтаксис-помощнике к обработчику "ПриКопировании"
//  ДокументОбъект	 	 - ДокументОбъект.* - обрабатываемый документ.
//
Процедура ПриКопированииПеремаркировкаТоваров(ОбъектКопирования, ДокументОбъект) Экспорт
	
	
КонецПроцедуры

// Обработка проведения перемаркировка товаров
//
// Параметры:
//  Отказ			 - Булево - Отказ.
//  РежимПроведения	 - РежимПроведения - Режим проведения документа.
//  ДокументОбъект	 - ДокументОбъект.* - обрабатываемый документ.
//
Процедура ОбработкаПроведенияПеремаркировкаТоваров(Отказ, РежимПроведения, ДокументОбъект) Экспорт
	
	
КонецПроцедуры

// Обработка удаления проведения перемаркировка товаров
//
// Параметры:
//  Отказ			 - Булево - Отказ.
//  ДокументОбъект	 - ДокументОбъект.* - обрабатываемый документ.
//
Процедура ОбработкаУдаленияПроведенияПеремаркировкаТоваров(Отказ, ДокументОбъект) Экспорт
	
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

#Область ПроцедурыИФункцииФормыДокумента

// Заполняет номенклатуру КиЗ в строке документа
//
// Параметры:
//  ТекущаяСтрока				 - ТекущаяСтрока - текущая строка таблицы Товары.
//  СписокНоменклатураКиЗ		 - СписокЗначений - список номенклатуры КиЗ, подходящих под выбранную категорию КиЗ в документе.
//  КиЗГИСМСИндивидуализацией	 - Булево - Признак получения КиЗ по GTIN или без GTIN.
//
Процедура ЗаполнитьНоменклатуруКиЗВСтроке(ТекущаяСтрока, СписокНоменклатураКиЗ, КиЗГИСМСИндивидуализацией) Экспорт
	
	ИнтеграцияГИСМУНФ.ЗаполнитьНоменклатуруКиЗВСтроке(
		ТекущаяСтрока,
		СписокНоменклатураКиЗ,
		КиЗГИСМСИндивидуализацией);
	
КонецПроцедуры

// Заполняет GTIN в строке документа
//
// Параметры:
//  ТекущаяСтрока				 - ТекущаяСтрока - текущая строка таблицы Товары.
//
Процедура ЗаполнитьGTINВСтроке(ТекущаяСтрока) Экспорт
	
	Перем Параметры;
	
	Запрос = Новый Запрос;
		Запрос.Текст = "
		|ВЫБРАТЬ
		|	ШтрихкодыНоменклатуры.Номенклатура КАК Номенклатура,
		|	ШтрихкодыНоменклатуры.Характеристика КАК Характеристика,
		|	ШтрихкодыНоменклатуры.Штрихкод КАК GTIN
		|ИЗ
		|	РегистрСведений.ШтрихкодыНоменклатуры КАК ШтрихкодыНоменклатуры
		|ГДЕ
		|	ШтрихкодыНоменклатуры.Номенклатура = &Номенклатура
		|	И ВЫБОР
		|		КОГДА &ХарактеристикаЗаполнена ТОГДА
		|			ШтрихкодыНоменклатуры.Характеристика = &Характеристика
		|		ИНАЧЕ
		|			ИСТИНА
		|	КОНЕЦ";
	Запрос.УстановитьПараметр("Номенклатура", ТекущаяСтрока.Номенклатура);
	Запрос.УстановитьПараметр("Характеристика", ТекущаяСтрока.Характеристика);
	Запрос.УстановитьПараметр("ХарактеристикаЗаполнена", ЗначениеЗаполнено(ТекущаяСтрока.Характеристика));
	ТаблицаGTIN = Запрос.Выполнить().Выгрузить();
	
	Если ТаблицаGTIN.Количество() = 1 Тогда
		СтрокаТаблицы = ТаблицаGTIN.Получить(0);
		Если МенеджерОборудованияКлиентСервер.ПроверитьКорректностьGTIN(СтрокаТаблицы.GTIN) Тогда
			ТекущаяСтрока.GTIN = СтрокаТаблицы.GTIN;
		КонецЕсли;
	ИначеЕсли ТаблицаGTIN.Найти(ТекущаяСтрока.GTIN, "GTIN") <> Неопределено Тогда
		// ничего не делаем, GTIN подходит
	Иначе
		ТекущаяСтрока.GTIN = Неопределено;
	КонецЕсли;
	
КонецПроцедуры

// Заполняет номенклатуру КиЗ в строках документа
//
// Параметры:
//  Объект				 		 - ДокументОбъект.* - текущая строка таблицы Товары.
//  СписокНоменклатураКиЗ		 - СписокЗначений - список номенклатуры КиЗ, подходящих под выбранную категорию КиЗ в документе.
//  ЗаполнятьСерии				 - Булево - Признак заполнения серий в ТЧ Серии.
//
Процедура ЗаполнитьНоменклатуруКиЗВСтроках(Объект, СписокНоменклатураКиЗ, ЗаполнятьСерии = Истина) Экспорт
	
	ИнтеграцияГИСМУНФ.ЗаполнитьНоменклатуруКиЗВСтроках(Объект, СписокНоменклатураКиЗ, ЗаполнятьСерии);
	
КонецПроцедуры

// Заполняет список КиЗ, подходящих для заполнения документ по выбранным категориям КиЗ.
//
// Параметры:
//  Объект				 		 - ДокументОбъект.* - текущая строка таблицы Товары.
//  СписокНоменклатураКиЗ		 - СписокЗначений - список номенклатуры КиЗ, подходящих под выбранную категорию КиЗ в документе.
//
Процедура ПолучитьКиЗДляЗаполнения(Объект, СписокНоменклатураКиЗ) Экспорт
	
	СписокНоменклатураКиЗ.Очистить();
	
	Если НЕ ЗначениеЗаполнено(Объект.КиЗГИСМВид)
		И НЕ ЗначениеЗаполнено(Объект.КиЗГИСМРазмер)
		И НЕ ЗначениеЗаполнено(Объект.КиЗГИСМСпособВыпускаВОборот) Тогда
		
		Возврат
		
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
		|	Номенклатура.Ссылка КАК НоменклатураКиЗ
		|ИЗ
		|	Справочник.Номенклатура КАК Номенклатура
		|ГДЕ
		|	Номенклатура.КиЗГИСМВид = &КиЗГИСМВид
		|	И Номенклатура.КиЗГИСМСпособВыпускаВОборот = &КиЗГИСМСпособВыпускаВОборот
		|	И Номенклатура.КиЗГИСМРазмер = &КиЗГИСМРазмер
		|	И НЕ Номенклатура.ПометкаУдаления
		|	И ВЫБОР КОГДА &КиЗГИСМСИндивидуализацией = ЛОЖЬ ТОГДА
		|		НЕ Номенклатура.ИспользоватьХарактеристики 
		|		И Номенклатура.КиЗГИСМGTIN ПОДОБНО """"
		|	ИНАЧЕ
		|		Номенклатура.ИспользоватьХарактеристики
		|		ИЛИ НЕ Номенклатура.КиЗГИСМGTIN ПОДОБНО """" 
		|	КОНЕЦ";
	
	Запрос.УстановитьПараметр("КиЗГИСМВид",                  Объект.КиЗГИСМВид);
	Запрос.УстановитьПараметр("КиЗГИСМРазмер",               Объект.КиЗГИСМРазмер);
	Запрос.УстановитьПараметр("КиЗГИСМСпособВыпускаВОборот", Объект.КиЗГИСМСпособВыпускаВОборот);
	Запрос.УстановитьПараметр("КиЗГИСМСИндивидуализацией",   Объект.КиЗГИСМСИндивидуализацией);
	
	Выборка = Запрос.Выполнить().Выбрать();
	СписокНоменклатураКиЗ.Очистить();
	Пока Выборка.Следующий() Цикл
		СписокНоменклатураКиЗ.Добавить(Выборка.НоменклатураКиЗ);
	КонецЦикла;

	
КонецПроцедуры

// Заполняет списки выбора реквизитов шапки.
//
// Параметры:
//  Форма	 - УправляемаяФорма - форма документа
//
Процедура ЗаполнитьСпискиВыбораРеквизитовШапки(Форма) Экспорт
	
	
КонецПроцедуры

// Заполняет списки выбора реквизитов шапки.
//
// Параметры:
//  Форма	 - УправляемаяФорма - форма документа
//
Процедура ЗаполнитьСпискиВыбораРеквизитовШапкиПеремаркировкаТоваров(Форма) Экспорт
	
	
КонецПроцедуры

// Обработчик Категория КиЗ при изменении
//
// Параметры:
//  ДокументОбъект			 - ДокументОбъект.* - обрабатываемый документ.
//  СписокНоменклатураКиЗ	 - СписокЗначений - список номенклатуры КиЗ, подходящих под выбранную категорию КиЗ в документе.
//  ЗаполнятьСерии			 - Булево - Признак заполнения серий в ТЧ Серии.
//
Процедура КатегорияКиЗПриИзменении(ДокументОбъект, СписокНоменклатураКиЗ, ЗаполнятьСерии = Истина) Экспорт
	
	ПолучитьКиЗДляЗаполнения(ДокументОбъект, СписокНоменклатураКиЗ);
	ИнтеграцияГИСМУНФ.ЗаполнитьНоменклатуруКиЗВСтроках(ДокументОбъект, СписокНоменклатураКиЗ, ЗаполнятьСерии);
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти
