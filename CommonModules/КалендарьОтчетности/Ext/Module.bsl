///////////////////////////////////////////////////////////////////////////////
// Размещаются процедуры и функции для работы по разделу Календарь отчетности

Функция ЗапуститьЗаполнениеВФоне(ИдентификаторФормы, Организация = Неопределено, ИзменилсяВидОрганизации = Ложь) Экспорт
	
	ПараметрыФункции = Новый Структура();
	ПараметрыФункции.Вставить("Организация", Организация);
	ПараметрыФункции.Вставить("ИзменилсяВидОрганизации", ИзменилсяВидОрганизации);
	
	Результат = ДлительныеОперации.ЗапуститьВыполнениеВФоне(
		ИдентификаторФормы,
		"КалендарьОтчетности.ЗаполнитьВФоне", 
		ПараметрыФункции, 
		НСтр("ru = 'Обновление списка задач отчетности'"));
	
	Возврат Результат;
	
КонецФункции

Процедура ЗаполнитьВФоне(Параметры, ВременноеХранилищеРезультата) Экспорт
	Перем Организация;
	
	Если Параметры <> Неопределено Тогда
		
		Параметры.Свойство("Организация", Организация);
		
	КонецЕсли;
	
	
	ИзмененыЗадачи = ЗарегистрироватьНовыеСобытияКалендаряОтчетностиКИсполнению(Организация);
	
	ПоместитьВоВременноеХранилище(ИзмененыЗадачи, ВременноеХранилищеРезультата);
	
КонецПроцедуры


// Функция анализирует, появились ли новые события календаря отчетности, 
// чтобы зарегистрировать их к исполнению у текущего абонента 
// Анализ производится по всем или выбранной организациям абонента. 
// 
Функция ЗарегистрироватьНовыеСобытияКалендаряОтчетностиКИсполнению(Организация = Неопределено) Экспорт
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	КалендарьПодготовкиОтчетности.Ссылка КАК СобытиеКалендаря,
	|	КалендарьПодготовкиОтчетности.ПрименяетсяДляИП,
	|	КалендарьПодготовкиОтчетности.ПрименяетсяДляООО,
	|	ВЫБОР
	|		КОГДА ЗадачиКалендаря.Родитель = ЗНАЧЕНИЕ(Справочник.ЗадачиКалендаряПодготовкиОтчетности.УСН)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ПрименяетсяДляУСН,
	|	ВЫБОР
	|		КОГДА ЗадачиКалендаря.Родитель = ЗНАЧЕНИЕ(Справочник.ЗадачиКалендаряПодготовкиОтчетности.ЕНВД)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ПрименяетсяДляЕНВД,
	|	ВЫБОР
	|		КОГДА ЗадачиКалендаря.Родитель = ЗНАЧЕНИЕ(Справочник.ЗадачиКалендаряПодготовкиОтчетности.ФСРАР)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ПрименяетсяДляАлко,
	|	ВЫБОР
	|		КОГДА ЗадачиКалендаря.Ссылка В (&МассивЗадачПоСотрудникам)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ПрименяетсяДляСотрудников
	|ПОМЕСТИТЬ ВТКалендарь
	|ИЗ
	|	Справочник.КалендарьПодготовкиОтчетности КАК КалендарьПодготовкиОтчетности
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.ЗадачиКалендаряПодготовкиОтчетности КАК ЗадачиКалендаря
	|		ПО КалендарьПодготовкиОтчетности.Задача = ЗадачиКалендаря.Ссылка
	|ГДЕ
	|	НЕ КалендарьПодготовкиОтчетности.ПометкаУдаления
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Организации.Ссылка КАК Ссылка,
	|	Организации.ЮридическоеФизическоеЛицо КАК ВидОрганизации,
	|	Организации.ИПИспользуетТрудНаемныхРаботников КАК ИПИспользуетТрудНаемныхРаботников
	|ПОМЕСТИТЬ ВТОрганизации
	|ИЗ
	|	Справочник.Организации КАК Организации
	|ГДЕ
	|	НЕ Организации.ПометкаУдаления
	|	И Организации.ИспользуетсяОтчетность
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СобытияКРегистрацииПоОрганизациям.СобытиеКалендаря,
	|	СобытияКРегистрацииПоОрганизациям.Организация,
	|	СобытияКРегистрацииПоОрганизациям.СобытиеКалендаря.Задача КАК Задача,
	|	ЗарегистрированныеСобытияКалендаря.Ссылка КАК ЗаписьКалендаря
	|ИЗ
	|	(ВЫБРАТЬ
	|		КалендарьПодготовкиОтчетности.СобытиеКалендаря КАК СобытиеКалендаря,
	|		ОрганизацииАбонента.Ссылка КАК Организация
	|	ИЗ
	|		ВТОрганизации КАК ОрганизацииАбонента
	|			ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СистемыНалогообложенияОрганизаций.СрезПоследних КАК СистемыНалогообложенияОрганизаций
	|			ПО ОрганизацииАбонента.Ссылка = СистемыНалогообложенияОрганизаций.Организация
	|			ЛЕВОЕ СОЕДИНЕНИЕ ВТКалендарь КАК КалендарьПодготовкиОтчетности
	|			ПО (ОрганизацииАбонента.ВидОрганизации = &ИП
	|						И КалендарьПодготовкиОтчетности.ПрименяетсяДляИП
	|					ИЛИ ОрганизацииАбонента.ВидОрганизации = &ООО
	|						И КалендарьПодготовкиОтчетности.ПрименяетсяДляООО)
	|				И (ЕСТЬNULL(СистемыНалогообложенияОрганизаций.ПлательщикУСН, ЛОЖЬ)
	|					ИЛИ НЕ КалендарьПодготовкиОтчетности.ПрименяетсяДляУСН)
	|				И (ЕСТЬNULL(СистемыНалогообложенияОрганизаций.ПлательщикЕНВД, ЛОЖЬ)
	|					ИЛИ НЕ КалендарьПодготовкиОтчетности.ПрименяетсяДляЕНВД)
	|				И (ОрганизацииАбонента.ВидОрганизации = &ООО
	|					ИЛИ ОрганизацииАбонента.ИПИспользуетТрудНаемныхРаботников
	|					ИЛИ НЕ КалендарьПодготовкиОтчетности.ПрименяетсяДляСотрудников)
	|				И (ЕСТЬNULL(СистемыНалогообложенияОрганизаций.РозничнаяПродажаАлкоголя, ЛОЖЬ)
	|					ИЛИ НЕ КалендарьПодготовкиОтчетности.ПрименяетсяДляАлко)
	|	ГДЕ
	|		&Условие) КАК СобытияКРегистрацииПоОрганизациям
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЗаписиКалендаряПодготовкиОтчетности КАК ЗарегистрированныеСобытияКалендаря
	|		ПО СобытияКРегистрацииПоОрганизациям.СобытиеКалендаря = ЗарегистрированныеСобытияКалендаря.СобытиеКалендаря
	|			И СобытияКРегистрацииПоОрганизациям.Организация = ЗарегистрированныеСобытияКалендаря.Организация
	|ГДЕ
	|	(ЗарегистрированныеСобытияКалендаря.Ссылка ЕСТЬ NULL 
	|			ИЛИ ЗарегистрированныеСобытияКалендаря.ПометкаУдаления)
	|
	|УПОРЯДОЧИТЬ ПО
	|	СобытияКРегистрацииПоОрганизациям.СобытиеКалендаря.ДатаОкончанияСобытия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗаписиКалендаряПодготовкиОтчетности.Ссылка
	|ИЗ
	|	Справочник.ЗаписиКалендаряПодготовкиОтчетности КАК ЗаписиКалендаряПодготовкиОтчетности
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТКалендарь КАК КалендарьПодготовкиОтчетности
	|		ПО ЗаписиКалендаряПодготовкиОтчетности.СобытиеКалендаря = КалендарьПодготовкиОтчетности.СобытиеКалендаря
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТОрганизации КАК ОрганизацииАбонента
	|		ПО ЗаписиКалендаряПодготовкиОтчетности.Организация = ОрганизацииАбонента.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СистемыНалогообложенияОрганизаций.СрезПоследних КАК СистемыНалогообложенияОрганизаций
	|		ПО ЗаписиКалендаряПодготовкиОтчетности.Организация = СистемыНалогообложенияОрганизаций.Организация
	|ГДЕ
	|	(НЕ ЗаписиКалендаряПодготовкиОтчетности.ПометкаУдаления
	|				И (ОрганизацииАбонента.ВидОрганизации = &ООО
	|						И НЕ КалендарьПодготовкиОтчетности.ПрименяетсяДляООО
	|					ИЛИ ОрганизацииАбонента.ВидОрганизации = &ИП
	|						И НЕ КалендарьПодготовкиОтчетности.ПрименяетсяДляИП
	|					ИЛИ НЕ ЕСТЬNULL(СистемыНалогообложенияОрганизаций.ПлательщикУСН, ЛОЖЬ)
	|						И КалендарьПодготовкиОтчетности.ПрименяетсяДляУСН
	|					ИЛИ НЕ ЕСТЬNULL(СистемыНалогообложенияОрганизаций.ПлательщикЕНВД, ЛОЖЬ)
	|						И КалендарьПодготовкиОтчетности.ПрименяетсяДляЕНВД
	|					ИЛИ КалендарьПодготовкиОтчетности.ПрименяетсяДляСотрудников
	|						И ОрганизацииАбонента.ВидОрганизации = ЗНАЧЕНИЕ(Перечисление.ЮридическоеФизическоеЛицо.ФИЗическоеЛицо)
	|						И НЕ ОрганизацииАбонента.ИПИспользуетТрудНаемныхРаботников)
	|			ИЛИ НЕ ЕСТЬNULL(СистемыНалогообложенияОрганизаций.РозничнаяПродажаАлкоголя, ЛОЖЬ)
	|				И КалендарьПодготовкиОтчетности.ПрименяетсяДляАлко
	|				И &Условие)");
	
	Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДатаСеанса());
	Запрос.УстановитьПараметр("ИП", Перечисления.ЮридическоеФизическоеЛицо.ФизическоеЛицо);
	Запрос.УстановитьПараметр("ООО", Перечисления.ЮридическоеФизическоеЛицо.ЮридическоеЛицо);
	МассивЗадачПоСотрудникам = Справочники.ЗадачиКалендаряПодготовкиОтчетности.ПолучитьМассивЗадачПоСотрудникам();
	Запрос.УстановитьПараметр("МассивЗадачПоСотрудникам", МассивЗадачПоСотрудникам);
	
	Если Организация <> Неопределено Тогда
		Запрос.УстановитьПараметр("Организация", Организация);
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "&Условие", "ОрганизацииАбонента.Ссылка = &Организация");
	Иначе
		Запрос.УстановитьПараметр("Условие", Истина);
	КонецЕсли;
	ПакетЗапроса = Запрос.ВыполнитьПакет();
	
	// Задачи к регистрации
	Результат = ПакетЗапроса[2];
	БылиИзмененыЗадачи = Ложь;
	
	Если НЕ Результат.Пустой() Тогда
		БылиИзмененыЗадачи = Истина;
		НачатьТранзакцию();
		Выборка = Результат.Выбрать();
		Пока Выборка.Следующий() Цикл
			Если ЗначениеЗаполнено(Выборка.ЗаписьКалендаря) Тогда 
				ЗаписьКалендаряПодготовкиОтчетности = Выборка.ЗаписьКалендаря.ПолучитьОбъект();
				ЗаписьКалендаряПодготовкиОтчетности.УстановитьПометкуУдаления(Ложь);
			Иначе
				ЗаписьКалендаряПодготовкиОтчетности = Справочники.ЗаписиКалендаряПодготовкиОтчетности.СоздатьЭлемент();
			КонецЕсли;
			ЗаписьКалендаряПодготовкиОтчетности.Организация = Выборка.Организация;
			ЗаписьКалендаряПодготовкиОтчетности.СобытиеКалендаря = Выборка.СобытиеКалендаря;
			ЗаписьКалендаряПодготовкиОтчетности.Состояние = Перечисления.СостоянияСобытийКалендаря.НеНачато;
			ЗаписьКалендаряПодготовкиОтчетности.ДополнительнаяИнформация = КалендарьОтчетностиПовтИсп.ПолучитьНачальныйСтатусСобытияПоВидуЗадачи(Выборка.Задача);
			ЗаписьКалендаряПодготовкиОтчетности.Записать();
		КонецЦикла;
		ЗафиксироватьТранзакцию();
	КонецЕсли;
	
	// Задачи к удалению
	Результат = ПакетЗапроса[3];
	Если НЕ Результат.Пустой() Тогда
		БылиИзмененыЗадачи = Истина;
		НачатьТранзакцию();
		Выборка = Результат.Выбрать();
		Пока Выборка.Следующий() Цикл
			ОбъектЗаписьКалендаря = Выборка.Ссылка.ПолучитьОбъект();
			ОбъектЗаписьКалендаря.УстановитьПометкуУдаления(Истина);
		КонецЦикла;
		ЗафиксироватьТранзакцию();
	КонецЕсли;
	
	Возврат БылиИзмененыЗадачи;
	
КонецФункции

// Возвращает дату смены последнего события
//
//
Функция ПолучитьДатуСменыСостояния(Организация, СобытиеКалендаря) Экспорт
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ЗаписиКалендаряПодготовкиОтчетности.ДатаСменыСостояния Как ДатаСменыСостояния
	|ИЗ
	|	Справочник.ЗаписиКалендаряПодготовкиОтчетности КАК ЗаписиКалендаряПодготовкиОтчетности
	|ГДЕ
	|	ЗаписиКалендаряПодготовкиОтчетности.Организация = &Организация
	|	И ЗаписиКалендаряПодготовкиОтчетности.СобытиеКалендаря = &СобытиеКалендаря
	|	И Не ЗаписиКалендаряПодготовкиОтчетности.ПометкаУдаления");
	
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("СобытиеКалендаря", СобытиеКалендаря);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		Возврат Выборка.ДатаСменыСостояния;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

//-----------------------------------------------------------------------------
// Секция поиска документов для отчетности




// Функция осуществляет поиск подходящего события календаря по задаче
// Поиск находит первое событие по передаваемой задаче, по которой работа пользовател
// не была еще завершена.
//
// Параметры:
//		ЗадачаКалендаря - СправочникСсылка.ЗадачиКалендаряОтчетности
//		Организация - СправочникСсылка.Организации - по некоторым ОЕ события могут быть уже завершены
//
Функция НайтиСобытиеКалендаряПоЗадаче(ЗадачаКалендаря, Организация) Экспорт
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ЗаписиКалендаряПодготовкиОтчетности.СобытиеКалендаря КАК СобытиеКалендаря
	|ИЗ
	|	Справочник.ЗаписиКалендаряПодготовкиОтчетности КАК ЗаписиКалендаряПодготовкиОтчетности
	|ГДЕ
	|	ЗаписиКалендаряПодготовкиОтчетности.Организация = &Организация
	|	И НЕ ЗаписиКалендаряПодготовкиОтчетности.Завершено
	|	И ЗаписиКалендаряПодготовкиОтчетности.СобытиеКалендаря.Задача = &Задача
	|	И НЕ ЗаписиКалендаряПодготовкиОтчетности.СобытиеКалендаря.ПометкаУдаления
	|	И НЕ ЗаписиКалендаряПодготовкиОтчетности.ПометкаУдаления
	|
	|УПОРЯДОЧИТЬ ПО
	|	ЗаписиКалендаряПодготовкиОтчетности.СобытиеКалендаря.ДатаНачалаСобытия");
	
	Запрос.УстановитьПараметр("Организация",Организация);
	Запрос.УстановитьПараметр("Задача",ЗадачаКалендаря);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		Возврат Выборка.СобытиеКалендаря;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

// Функция осуществляет поиск подходящего события календаря по задаче
// Поиск находит первое событие по передаваемой задаче, по которой работа пользовател
// не была еще завершена.
//
// Параметры:
//		ЗадачаКалендаря - СправочникСсылка.ЗадачиКалендаряОтчетности
//		Организация - СправочникСсылка.Организации - по некоторым ОЕ события могут быть уже завершены
// Возвращает:
//		Структура:
//			СобытиеКалендаря
//			СостояниеСобытия
//
Функция ПолучитьСтруктуруСобытияКалендаряПоЗадаче(ЗадачаКалендаря, Организация) Экспорт
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ЗаписиКалендаряПодготовкиОтчетности.СобытиеКалендаря КАК СобытиеКалендаря,
	|	ЗаписиКалендаряПодготовкиОтчетности.Состояние КАК СостояниеСобытия
	|ИЗ
	|	Справочник.ЗаписиКалендаряПодготовкиОтчетности КАК ЗаписиКалендаряПодготовкиОтчетности
	|ГДЕ
	|	ЗаписиКалендаряПодготовкиОтчетности.Организация = &Организация
	|	И НЕ ЗаписиКалендаряПодготовкиОтчетности.Завершено
	|	И ЗаписиКалендаряПодготовкиОтчетности.СобытиеКалендаря.Задача = &Задача
	|	И НЕ ЗаписиКалендаряПодготовкиОтчетности.СобытиеКалендаря.ПометкаУдаления
	|	И НЕ ЗаписиКалендаряПодготовкиОтчетности.ПометкаУдаления
	|
	|УПОРЯДОЧИТЬ ПО
	|	ЗаписиКалендаряПодготовкиОтчетности.СобытиеКалендаря.ДатаНачалаСобытия");
	
	Запрос.УстановитьПараметр("Организация",Организация);
	Запрос.УстановитьПараметр("Задача",ЗадачаКалендаря);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		Возврат Новый Структура("СобытиеКалендаря, СостояниеСобытия", Выборка.СобытиеКалендаря, Выборка.СостояниеСобытия);
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

Функция ПолучитьСобытиеРасчетаЕдиногоНалогаВПериоде(ПериодОтчетности) Экспорт
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	КалендарьПодготовкиОтчетности.Ссылка
	|ИЗ
	|	Справочник.КалендарьПодготовкиОтчетности КАК КалендарьПодготовкиОтчетности
	|ГДЕ
	|	КалендарьПодготовкиОтчетности.Задача = &Задача
	|	И КалендарьПодготовкиОтчетности.ДатаДокументаОбработкиСобытия МЕЖДУ &ДатаНачалаСобытия И &ДатаОкончанияСобытия");
	
	Запрос.УстановитьПараметр("Задача", Справочники.ЗадачиКалендаряПодготовкиОтчетности.ЕдиныйНалог);
	Запрос.УстановитьПараметр("ДатаНачалаСобытия", НачалоГода(ПериодОтчетности));
	Запрос.УстановитьПараметр("ДатаОкончанияСобытия", КонецГода(ПериодОтчетности));
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Ссылка;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

// Конец секции поиска
//-----------------------------------------------------------------------------


//-----------------------------------------------------------------------------
// секция работы с документы отчетности

// Процедура записывает состояние в регистр состояния событий по отчетности
//
Процедура ЗаписатьСостояниеСобытияКалендаря(Организация, СобытиеКалендаря, СостояниеКалендаря, ДополнительнаяИнформация) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ЗаписиКалендаряПодготовкиОтчетности.Ссылка
	|ИЗ
	|	Справочник.ЗаписиКалендаряПодготовкиОтчетности КАК ЗаписиКалендаряПодготовкиОтчетности
	|ГДЕ
	|	ЗаписиКалендаряПодготовкиОтчетности.Организация = &Организация
	|	И ЗаписиКалендаряПодготовкиОтчетности.СобытиеКалендаря = &СобытиеКалендаря";
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("СобытиеКалендаря", СобытиеКалендаря);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Запись = Выборка.Ссылка.ПолучитьОбъект();
	Иначе
		Запись = Справочники.ЗаписиКалендаряПодготовкиОтчетности.СоздатьЭлемент();
	КонецЕсли;
	Запись.Организация				= Организация;
	Запись.СобытиеКалендаря			= СобытиеКалендаря;
	Запись.Состояние				= СостояниеКалендаря;
	Запись.ДополнительнаяИнформация	= ДополнительнаяИнформация;
	Запись.ДатаСменыСостояния		= ТекущаяДатаСеанса();
	Запись.Записать();
	
КонецПроцедуры

// Процедура по событию календаря и организации возвращает состояние события
//
Функция ПолучитьСостояниеСобытияКалендаря(Организация, СобытиеКалендаря) Экспорт
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ЗаписиКалендаряПодготовкиОтчетности.Состояние
	|ИЗ
	|	Справочник.ЗаписиКалендаряПодготовкиОтчетности КАК ЗаписиКалендаряПодготовкиОтчетности
	|ГДЕ
	|	ЗаписиКалендаряПодготовкиОтчетности.Организация = &Организация
	|	И ЗаписиКалендаряПодготовкиОтчетности.СобытиеКалендаря = &СобытиеКалендаря");
	
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("СобытиеКалендаря", СобытиеКалендаря);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Состояние;
	Иначе
		Возврат Перечисления.СостоянияСобытийКалендаря.Заполнить;
	КонецЕсли;
	
КонецФункции
 
// Процедура определяет состояние события календаря на основании документа
// отчетности
//
// В случае, если не удается определить состояние события, то вовзращает Неопределено
//
// Параметры: 
//		ДокументОтчетности - ДокументСсылка
//
// Возвращает:
//		Перечисление.СостояниеСобытийКалендаряОтчетности или Неопределено
//
Функция ПолучитьСостояниеСобытияКалендаряПоДокументуОтчетности(ДокументОтчетности) Экспорт
	
	ИмяДокумента = ДокументОтчетности.Метаданные().Имя;
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ЗаписиКалендаряПодготовкиОтчетности.Состояние КАК Состояние
	|ИЗ
	|	Справочник.ЗаписиКалендаряПодготовкиОтчетности КАК ЗаписиКалендаряПодготовкиОтчетности
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ." + ИмяДокумента +" КАК ДокументОтчетности
	|		ПО ЗаписиКалендаряПодготовкиОтчетности.Организация = ДокументОтчетности.Организация
	|			И ЗаписиКалендаряПодготовкиОтчетности.СобытиеКалендаря = ДокументОтчетности.СобытиеКалендаря
	|			И (ДокументОтчетности.Ссылка = &Документ)");
	
	Запрос.УстановитьПараметр("Документ", ДокументОтчетности);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Состояние;
	Иначе
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции



// Процедура записывает состояние в регистр состояния событий по отчетности
//
Процедура ЗавершитьСобытиеКалендаряОтчетности(Организация, СобытиеКалендаря, ДополнительнаяИнформация) Экспорт
	
	НачатьТранзакцию();
	
	
	Ссылка = Справочники.ЗаписиКалендаряПодготовкиОтчетности.ПолучитьЗаписьКалендаря(Организация, СобытиеКалендаря);
	
	Если Ссылка <> Неопределено Тогда
		Запись = Ссылка.ПолучитьОбъект();
	Иначе
		Запись = Справочники.ЗаписиКалендаряПодготовкиОтчетности.СоздатьЭлемент();
	КонецЕсли;
	
	Запись.Организация				= Организация;
	Запись.СобытиеКалендаря			= СобытиеКалендаря;
	Запись.Состояние				= Перечисления.СостоянияСобытийКалендаря.Завершено;
	Запись.ДополнительнаяИнформация	= ДополнительнаяИнформация;
	Запись.ДатаСменыСостояния		= ТекущаяДатаСеанса();
	Запись.Завершено = Истина;
	Запись.Записать();
	
	ЗафиксироватьТранзакцию();
	
КонецПроцедуры




// конец секции работы с документами отчетности
//-----------------------------------------------------------------------------


