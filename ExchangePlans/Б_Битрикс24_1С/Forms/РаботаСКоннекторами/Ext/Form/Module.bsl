
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ИдентификаторКоннектора = Б_Битрикс24_1С_Сервер.ПолучитьИдБазы1С();
	НазваниеКоннектора 		= Б_Битрикс24_1С_Сервер.ПолучитьНазваниеКоннектора();
	АдресНаВеб1С			= Константы.Б_АдресНаВебСервере.Получить();	
	
	СтруктураВозврата = ПолучитьКоннкеторыСПортала();

	ЗаполнитьТаблицуКоннекторов(СтруктураВозврата);
	
КонецПроцедуры

&НаСервере
Функция ПолучитьКоннкеторыСПортала()
	
	НастройкиВыгрузки = Б_Битрикс24_1С_Сервер.ПолучитьНастройкиПоУмолчанию();
	
	Если НЕ ЗначениеЗаполнено(НастройкиВыгрузки) тогда
		Сообщить("Не найдена используемая настройка выгрузки. Удалить настройки нельзя");
		Возврат Новый Структура;
	КонецЕсли;
	
	СтруктураВозврата = Б_Битрикс24_1С_Сервер.ПолучитьКоннекторыНаПортале(НастройкиВыгрузки);
	
	Возврат СтруктураВозврата;
	
КонецФункции

&НаСервере
Процедура ЗаполнитьТаблицуКоннекторов(СтруктураДанных)
	
	Коннекторы.Очистить();
	
	Если СтруктураДанных = Ложь тогда
		Возврат;	
	КонецЕсли;
	
	Если СтруктураДанных.Свойство("result") = Истина тогда
		
		Если ТипЗнч(СтруктураДанных.result) = Тип("Массив") тогда
			
			Для Каждого ТекСтрока из СтруктураДанных.result Цикл
				Если ТекСтрока.TYPE_ID = "ONE_C" тогда
					НоваяСтрока = Коннекторы.Добавить();
					НоваяСтрока.Название 				= ТекСтрока.NAME;
					НоваяСтрока.ИдентификаторКанала 	= ТекСтрока.CHANNEL_ID;
					НоваяСтрока.ИдентификаторКоннектора = ТекСтрока.ORIGINATOR_ID;
					НоваяСтрока.ТипКоннектора 			= ТекСтрока.TYPE_ID;
				КонецЕсли;
			КонецЦикла;
			
		ИначеЕсли ТипЗнч(СтруктураДанных.result) = Тип("Структура") тогда
			
			Если СтруктураДанных.TYPE_ID = "ONE_C" тогда
				НоваяСтрока = Коннекторы.Добавить();
				НоваяСтрока.Название 				= СтруктураДанных.NAME;
				НоваяСтрока.ИдентификаторКанала 	= СтруктураДанных.CHANNEL_ID;
				НоваяСтрока.ИдентификаторКоннектора = СтруктураДанных.ORIGINATOR_ID;
				НоваяСтрока.ТипКоннектора 			= СтруктураДанных.TYPE_ID;
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура УдалитьКоннекторНаСервере(ИдентификаторКоннектора, ИдентификаторКанала)
	 Б_Битрикс24_1С_Сервер.УдалитьКоннектор(ИдентификаторКоннектора, ИдентификаторКанала);
КонецПроцедуры

&НаКлиенте
Процедура УдалитьКоннектор(Команда)
	
	ЗаписатьКонстанты();

	Если Элементы.Коннекторы.ТекущиеДанные <> неопределено тогда
		
		УдалитьКоннекторНаСервере(Элементы.Коннекторы.ТекущиеДанные.ИдентификаторКоннектора, Элементы.Коннекторы.ТекущиеДанные.ИдентификаторКанала);
		
		СтруктураВозврата = ПолучитьКоннкеторыСПортала();

		ЗаполнитьТаблицуКоннекторов(СтруктураВозврата);
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПередЗакрытием(Отказ, ЗавершениеРаботы, ТекстПредупреждения, СтандартнаяОбработка)
	ПередЗакрытиемНаСервере();
КонецПроцедуры

&НаСервере
Процедура ПередЗакрытиемНаСервере()
	
	ЗаписатьКонстанты();

КонецПроцедуры

&НаСервере
Процедура ОбновитьКоннекторНаСервере()
	
	Б_Битрикс24_1С_Сервер.ПерезаписатьКоннектор();
	
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьКоннектор(Команда)
	
	ЗаписатьКонстанты();

	ОбновитьКоннекторНаСервере();
		
	СтруктураВозврата = ПолучитьКоннкеторыСПортала();

	ЗаполнитьТаблицуКоннекторов(СтруктураВозврата);
		
КонецПроцедуры

&НаСервере
Процедура ЗаписатьКонстанты()
	
	Константы.Б_ИдентификаторКоннектора.Установить(ИдентификаторКоннектора);
	Константы.Б_НазваниеКоннектора.Установить(НазваниеКоннектора);
	Константы.Б_АдресНаВебСервере.Установить(АдресНаВеб1С);
	
КонецПроцедуры
