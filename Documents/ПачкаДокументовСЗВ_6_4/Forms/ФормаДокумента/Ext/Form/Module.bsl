&НаКлиенте
Перем НомерТекущейСтроиЗаписиОСтаже;

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

&НаСервере
Процедура ПриЧтенииНаСервере(ТекущийОбъект)
	ПриПолученииДанныхНаСервере(ТекущийОбъект);
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)	
	ЗаписиОСтажеТекст = НСтр("ru = 'Записи о стаже'");
	Если Параметры.Ключ.Пустая() Тогда
		ПриПолученииДанныхНаСервере(РеквизитФормыВЗначение("Объект", Тип("ДокументОбъект.ПачкаДокументовСЗВ_6_4")));
	КонецЕсли;	
КонецПроцедуры


&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	ДанныеФормыВОбъект(ТекущийОбъект);
КонецПроцедуры

&НаСервере
Процедура ПослеЗаписиНаСервере(ТекущийОбъект, ПараметрыЗаписи)
	
	ОбъектВДанныеФормы(ТекущийОбъект);
	
	УстановитьПредставлениеМесяцевЗаработкаСЗВ64(ЭтаФорма);
КонецПроцедуры

&НаКлиенте
Процедура КорректируемыйПериодРегулирование(Элемент, Направление, СтандартнаяОбработка)
	
	УстановитьПредставлениеМесяцевЗаработкаСЗВ64(ЭтаФорма);
КонецПроцедуры

&НаКлиенте
Процедура ТипСведенийПриИзменении(Элемент)
	ТипСведенийСЗВПриИзмененииНаСервере();	
	УстановитьПредставлениеМесяцевЗаработкаСЗВ64(ЭтаФорма);
КонецПроцедуры

&НаКлиенте
Процедура КомментарийНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	ОбщегоНазначенияКлиент.ПоказатьФормуРедактированияКомментария(Элемент.ТекстРедактирования, ЭтотОбъект, "Объект.Комментарий");
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ТАБЛИЦЫ "СОТРУДНИКИ"

&НаКлиенте
Процедура СотрудникПриАктивизацииСтроки(Элемент)
	УстановитьПредставлениеМесяцевЗаработкаСЗВ64(ЭтаФорма);
КонецПроцедуры

&НаКлиенте
Процедура СотрудникиПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа)
	Если Копирование Тогда
		Отказ = Истина;
	КонецЕсли;	
КонецПроцедуры

&НаКлиенте
Процедура ЗаписиОСтажеПередНачаломИзменения(Элемент, Отказ)
	НомерТекущейСтроиЗаписиОСтаже = Элементы.ЗаписиОСтаже.ТекущиеДанные.НомерСтроки;
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ КОМАНД ФОРМЫ

////////////////////////////////////////////////////////////////////////////////
// СЛУЖЕБНЫЕ ПРОЦЕДУРЫ И ФУНКЦИИ

&НаКлиентеНаСервереБезКонтекста
Процедура УстановитьПредставлениеМесяцевЗаработкаСЗВ64(Форма)
	
	Если Форма.Объект.ТипСведенийСЗВ = ПредопределенноеЗначение("Перечисление.ТипыСведенийСЗВ.ИСХОДНАЯ") Тогда
		ПериодДокумента = Форма.Объект.ОтчетныйПериод;
	Иначе
		ПериодДокумента = Форма.Объект.КорректируемыйПериод;
	КонецЕсли;
	
	Если Форма.Элементы.Сотрудники.ТекущаяСтрока <> Неопределено Тогда 
		ДанныеТекущейСтрокиСотрудник = Форма.Объект.Сотрудники.НайтиПоИдентификатору(Форма.Элементы.Сотрудники.ТекущаяСтрока);
	КонецЕсли;	
	
	Если ДанныеТекущейСтрокиСотрудник <> Неопределено Тогда
		Для Каждого СтрокаЗаработок Из ДанныеТекущейСтрокиСотрудник.СведенияОЗаработке Цикл
			СтрокаЗаработок.МесяцПредставление = Формат(Дата(2013, СтрокаЗаработок.Месяц + Месяц(ПериодДокумента) - 1, 1), "ДФ=ММММ");	
		КонецЦикла;
	КонецЕсли;	
КонецПроцедуры	

&НаСервере
Процедура ПриПолученииДанныхНаСервере(ТекущийОбъект)	
	
	ОбъектВДанныеФормы(ТекущийОбъект);
	
	УстановитьДоступностьПолейСтажа(ЭтаФорма);
КонецПроцедуры

&НаСервере
Процедура ОбъектВДанныеФормы(ТекущийОбъект)
	СтрокиПоСотрудникам = Новый Соответствие;
	
	Для Каждого СтрокаСотрудник Из Объект.Сотрудники Цикл
		СтрокаСотрудник.СведенияОЗаработке.Очистить();
		
		СтрокиПоСотрудникам.Вставить(СтрокаСотрудник.Сотрудник, СтрокаСотрудник);	
		
		Для НомерМесяца = 1 По 3 Цикл
			СтрокаЗаработок = СтрокаСотрудник.СведенияОЗаработке.Вставить(НомерМесяца - 1);
			СтрокаЗаработок.Месяц = НомерМесяца;	
		КонецЦикла;	
	КонецЦикла;	
	
	Для Каждого СтрокаЗаработок Из Объект.СведенияОЗаработке Цикл
		Если СтрокаЗаработок.Месяц > 0
			И СтрокаЗаработок.Месяц < 4 Тогда
		
			СтрокаПоСотруднику = СтрокиПоСотрудникам[СтрокаЗаработок.Сотрудник];	
			Если СтрокаПоСотруднику <> Неопределено Тогда
				СтрокаЗаработокПоСотруднику = СтрокаПоСотруднику.СведенияОЗаработке[СтрокаЗаработок.Месяц - 1];
				ЗаполнитьЗначенияСвойств(СтрокаЗаработокПоСотруднику, СтрокаЗаработок);
			КонецЕсли;	
		КонецЕсли;	
	КонецЦикла;		
КонецПроцедуры	

&НаСервере
Процедура ДанныеФормыВОбъект(ТекущийОбъект)
	ТекущийОбъект.СведенияОЗаработке.Очистить();
	
	Для Каждого СтрокаСотрудник Из Объект.Сотрудники Цикл
		Для Каждого СтрокаЗаработокПоСотруднику Из СтрокаСотрудник.СведенияОЗаработке Цикл
			Если СтрокаСведенийОЗаработкеЗаполнена(СтрокаЗаработокПоСотруднику) Тогда
				СтрокаЗаработок = ТекущийОбъект.СведенияОЗаработке.Добавить();	
				ЗаполнитьЗначенияСвойств(СтрокаЗаработок, СтрокаЗаработокПоСотруднику);
				СтрокаЗаработок.Сотрудник = СтрокаСотрудник.Сотрудник;
			КонецЕсли;	
		КонецЦикла;	
	КонецЦикла;	
КонецПроцедуры	

&НаСервере 
Функция СтрокаСведенийОЗаработкеЗаполнена(СтрокаЗаработок)
	Если СтрокаЗаработок.Заработок <> 0
		Или СтрокаЗаработок.ОблагаетсяВзносамиДоПредельнойВеличины <> 0
		Или СтрокаЗаработок.ОблагаетсяВзносамиСвышеПредельнойВеличины <> 0
        Или СтрокаЗаработок.ОблагаетсяВзносамиЗаЗанятыхНаПодземныхИВредныхРаботах <> 0
		Или СтрокаЗаработок.ОблагаетсяВзносамиЗаЗанятыхНаТяжелыхИПрочихРаботах <> 0 Тогда
		
		Возврат Истина;
	КонецЕсли;	

	Возврат Ложь;		
КонецФункции	

&НаКлиентеНаСервереБезКонтекста
Процедура УстановитьДоступностьПолейСтажа(Форма)
	Если Форма.Объект.ТипСведенийСЗВ = ПредопределенноеЗначение("Перечисление.ТипыСведенийСЗВ.ОТМЕНЯЮЩАЯ") Тогда
		Форма.Элементы.ЗаписиОСтаже.Доступность = Ложь;
		Форма.Объект.ЗаписиОСтаже.Очистить();
	Иначе
		Форма.Элементы.ЗаписиОСтаже.Доступность = Истина;
	КонецЕсли;	
КонецПроцедуры	


&НаСервере
Процедура ТипСведенийСЗВПриИзмененииНаСервере()
	УстановитьДоступностьПолейСтажа(ЭтаФорма);
КонецПроцедуры



