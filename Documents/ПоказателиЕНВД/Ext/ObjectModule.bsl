#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ОбработчикиСобытий

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	Если ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	Дата = КонецКвартала(Дата);
	
	ДополнительныеСвойства.Вставить("ЭтоНовый",    ЭтоНовый());
	ДополнительныеСвойства.Вставить("РежимЗаписи", РежимЗаписи);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Процедура ЗаполнитьДанныеДокумента() Экспорт
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ВидыДеятельностиЕНВД.Ссылка,
	|	ВЫБОР
	|		КОГДА ВидыДеятельностиЕНВД.ДатаНачала = ДАТАВРЕМЯ(1, 1, 1)
	|			ТОГДА &ДатаНачала
	|		ИНАЧЕ ВидыДеятельностиЕНВД.ДатаНачала
	|	КОНЕЦ КАК ДатаНачала,
	|	ВЫБОР
	|		КОГДА ВидыДеятельностиЕНВД.ДатаОкончания = ДАТАВРЕМЯ(1, 1, 1)
	|				ИЛИ ВидыДеятельностиЕНВД.Актуально
	|			ТОГДА &ДатаОкончания
	|		ИНАЧЕ ВидыДеятельностиЕНВД.ДатаОкончания
	|	КОНЕЦ КАК ДатаОкончания
	|ИЗ
	|	Справочник.ВидыДеятельностиЕНВД КАК ВидыДеятельностиЕНВД
	|ГДЕ
	|	ВидыДеятельностиЕНВД.Владелец = &Организация
	|	И ( (ВидыДеятельностиЕНВД.Актуально И ВидыДеятельностиЕНВД.ДатаНачала < &ДатаОкончания)
	|			ИЛИ ВидыДеятельностиЕНВД.ДатаОкончания МЕЖДУ &Датаначала И &ДатаОкончания)");
	
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("ДатаНачала", НачалоКвартала(Дата));
	Запрос.УстановитьПараметр("ДатаОкончания", КонецКвартала(Дата));
	
	ПоказателиЕНВД.Очистить();
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	ДнейВсего = Новый Массив(3);
	
	ДнейВсего1 = День(КонецМесяца(НачалоКвартала(Дата)));
	ДнейВсего2 = День(КонецМесяца(КонецМесяца(НачалоКвартала(Дата))+1));
	ДнейВсего3 = День(КонецКвартала(Дата));
	
	Пока Выборка.Следующий() Цикл
		
		Стр = ПоказателиЕНВД.Добавить();
		Стр.ВидДеятельностиЕНВД = Выборка.Ссылка;
		
		НачДата = НачалоДня(Макс(НачалоКвартала(Дата),Выборка.ДатаНачала));
		КонДата = НачалоДня(Мин(КонецМесяца(НачалоКвартала(Дата)), Выборка.ДатаОкончания));
		Дней = (КонДата-НачДата)/(24*60*60);
		Стр.ВыработкаДней1 = ?(Дней>=0,Дней+1,0);
		
		НачДата = НачалоДня(Макс(ДобавитьМесяц(НачалоКвартала(Дата),1),Выборка.ДатаНачала));
		КонДата = НачалоДня(Мин(КонецМесяца(ДобавитьМесяц(НачалоКвартала(Дата),1)), Выборка.ДатаОкончания));
		Дней = (КонДата-НачДата)/(24*60*60);
		Стр.ВыработкаДней2 = ?(Дней>=0,Дней+1,0);
		
		НачДата = НачалоДня(Макс(ДобавитьМесяц(НачалоКвартала(Дата),2),Выборка.ДатаНачала));
		КонДата = НачалоДня(Мин(КонецМесяца(ДобавитьМесяц(НачалоКвартала(Дата),2)), Выборка.ДатаОкончания));
		Дней = (КонДата-НачДата)/(24*60*60);
		Стр.ВыработкаДней3 = ?(Дней>=0,Дней+1,0);

		
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#КонецЕсли