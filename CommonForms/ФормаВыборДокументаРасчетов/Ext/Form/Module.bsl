
//////////////////////////////////////////////////////////////////////////////// 
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ

// Получает запрос для выбора документов расчетов с покупателями 
// для документов "Поступление на счет" и "Поступление в кассу".
//
&НаСервереБезКонтекста
Функция ПолучитьТекстЗапросаДокументыРасчетовСПокупателямиПоступление(ОтборПоДоговору)
	
	ТекстЗапроса = "";
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.АктВыполненныхРабот) Тогда
		ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка КАК Ссылка,
		|	ДанныеДокумента.Дата КАК Дата,
		|	ДанныеДокумента.Номер КАК Номер,
		|	ДанныеДокумента.Организация КАК Организация,
		|	ДанныеДокумента.Контрагент КАК Контрагент,
		|	ДанныеДокумента.Договор КАК Договор,
		|	ДанныеДокумента.СуммаДокумента КАК Сумма,
		|	ДанныеДокумента.ВалютаДокумента КАК Валюта,
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка) КАК Тип,
		|	ВЫБОР
		|		КОГДА ДанныеДокумента.Проведен
		|			ТОГДА 1
		|		КОГДА ДанныеДокумента.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК СостояниеДокумента
		|ИЗ
		|	Документ.АктВыполненныхРабот КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.ЗаказПокупателя) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Номер,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	ДанныеДокумента.Договор,
		|	ДанныеДокумента.СуммаДокумента,
		|	ДанныеДокумента.ВалютаДокумента,
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка),
		|	ВЫБОР
		|		КОГДА ДанныеДокумента.Проведен
		|			ТОГДА 1
		|		КОГДА ДанныеДокумента.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ
		|ИЗ
		|	Документ.ЗаказПокупателя КАК ДанныеДокумента
		|ГДЕ
		|	ДанныеДокумента.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийЗаказПокупателя.ЗаказНаряд)";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.Взаимозачет) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Номер,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	&ДоговорПоУмолчанию,
		|	ДанныеДокумента.СуммаРасчетов,
		|	ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка),
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка),
		|	ВЫБОР
		|		КОГДА ДанныеДокумента.Проведен
		|			ТОГДА 1
		|		КОГДА ДанныеДокумента.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ
		|ИЗ
		|	Документ.Взаимозачет КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.ОтчетКомиссионера) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Номер,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	ДанныеДокумента.Договор,
		|	ДанныеДокумента.СуммаДокумента,
		|	ДанныеДокумента.ВалютаДокумента,
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка),
		|	ВЫБОР
		|		КОГДА ДанныеДокумента.Проведен
		|			ТОГДА 1
		|		КОГДА ДанныеДокумента.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ
		|ИЗ
		|	Документ.ОтчетКомиссионера КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.ОтчетОПереработке) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Номер,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	ДанныеДокумента.Договор,
		|	ДанныеДокумента.СуммаДокумента,
		|	ДанныеДокумента.ВалютаДокумента,
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка),
		|	ВЫБОР
		|		КОГДА ДанныеДокумента.Проведен
		|			ТОГДА 1
		|		КОГДА ДанныеДокумента.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ
		|ИЗ
		|	Документ.ОтчетОПереработке КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.ПередачаВА) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Номер,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	ДанныеДокумента.Договор,
		|	ДанныеДокумента.СуммаДокумента,
		|	ДанныеДокумента.ВалютаДокумента,
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка),
		|	ВЫБОР
		|		КОГДА ДанныеДокумента.Проведен
		|			ТОГДА 1
		|		КОГДА ДанныеДокумента.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ
		|ИЗ
		|	Документ.ПередачаВА КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.РасходнаяНакладная) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Номер,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	ДанныеДокумента.Договор,
		|	ДанныеДокумента.СуммаДокумента,
		|	ДанныеДокумента.ВалютаДокумента,
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка),
		|	ВЫБОР
		|		КОГДА ДанныеДокумента.Проведен
		|			ТОГДА 1
		|		КОГДА ДанныеДокумента.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ
		|ИЗ
		|	Документ.РасходнаяНакладная КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.ПриемИПередачаВРемонт) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Номер,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	Null,
		|	ДанныеДокумента.СуммаДокумента,
		|	ДанныеДокумента.ВалютаДокумента,
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка),
		|	ВЫБОР
		|		КОГДА ДанныеДокумента.Проведен
		|			ТОГДА 1
		|		КОГДА ДанныеДокумента.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ
		|ИЗ
		|	Документ.ПриемИПередачаВРемонт КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	Если Лев(ТекстЗапроса, 10) = "ОБЪЕДИНИТЬ" Тогда
		ТекстЗапроса = Сред(ТекстЗапроса, 14);
	КонецЕсли;
	
	Возврат ТекстЗапроса;
	
КонецФункции // ПолучитьТекстЗапросаДокументыРасчетовСПокупателями()

// Получает запрос для выбора документов расчетов с поставщиками 
// для документов "Поступление на счет" и "Поступление в кассу".
//
&НаСервереБезКонтекста
Функция ПолучитьТекстЗапросаДокументыРасчетовСПоставщикамиПоступление(ОтборПоДоговору)
	
	ТекстЗапроса = "";
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.АвансовыйОтчет) Тогда
		ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка КАК Ссылка,
		|	ДанныеДокумента.Дата КАК Дата,
		|	ДанныеДокумента.Номер КАК Номер,
		|	ДанныеДокумента.Организация КАК Организация,
		|	&КонтрагентПоУмолчанию КАК Контрагент,
		|	&ДоговорПоУмолчанию КАК Договор,
		|	ДанныеДокумента.СуммаДокумента КАК Сумма,
		|	ДанныеДокумента.ВалютаДокумента КАК Валюта,
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка) КАК Тип,
		|	ВЫБОР
		|		КОГДА ДанныеДокумента.Проведен
		|			ТОГДА 1
		|		КОГДА ДанныеДокумента.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК СостояниеДокумента
		|ИЗ
		|	Документ.АвансовыйОтчет КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.ДополнительныеРасходы) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Номер,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	ДанныеДокумента.Договор,
		|	ДанныеДокумента.СуммаДокумента,
		|	ДанныеДокумента.ВалютаДокумента,
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка),
		|	ВЫБОР
		|		КОГДА ДанныеДокумента.Проведен
		|			ТОГДА 1
		|		КОГДА ДанныеДокумента.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ
		|ИЗ
		|	Документ.ДополнительныеРасходы КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.Взаимозачет) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Номер,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	&ДоговорПоУмолчанию,
		|	ДанныеДокумента.СуммаРасчетов,
		|	ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка),
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка),
		|	ВЫБОР
		|		КОГДА ДанныеДокумента.Проведен
		|			ТОГДА 1
		|		КОГДА ДанныеДокумента.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ
		|ИЗ
		|	Документ.Взаимозачет КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.ОтчетКомитенту) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Номер,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	ДанныеДокумента.Договор,
		|	ДанныеДокумента.СуммаДокумента,
		|	ДанныеДокумента.ВалютаДокумента,
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка),
		|	ВЫБОР КОГДА ДанныеДокумента.Проведен ТОГДА
		|		1
		|	КОГДА ДанныеДокумента.ПометкаУдаления ТОГДА
		|		2
		|	ИНАЧЕ
		|		0
		|	КОНЕЦ
		|ИЗ
		|	Документ.ОтчетКомитенту КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.ОтчетПереработчика) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Номер,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	ДанныеДокумента.Договор,
		|	ДанныеДокумента.Сумма,
		|	ДанныеДокумента.ВалютаДокумента,
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка),
		|	ВЫБОР КОГДА ДанныеДокумента.Проведен ТОГДА
		|		1
		|	КОГДА ДанныеДокумента.ПометкаУдаления ТОГДА
		|		2
		|	ИНАЧЕ
		|		0
		|	КОНЕЦ
		|ИЗ
		|	Документ.ОтчетПереработчика КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.ПриходнаяНакладная) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Номер,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	ДанныеДокумента.Договор,
		|	ДанныеДокумента.СуммаДокумента,
		|	ДанныеДокумента.ВалютаДокумента,
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка),
		|	ВЫБОР
		|		КОГДА ДанныеДокумента.Проведен
		|			ТОГДА 1
		|		КОГДА ДанныеДокумента.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ
		|ИЗ
		|	Документ.ПриходнаяНакладная КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.РасходнаяНакладная) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	РасходнаяНакладная.Ссылка,
		|	РасходнаяНакладная.Дата,
		|	РасходнаяНакладная.Номер,
		|	РасходнаяНакладная.Организация,
		|	РасходнаяНакладная.Контрагент,
		|	РасходнаяНакладная.Договор,
		|	РасходнаяНакладная.СуммаДокумента,
		|	РасходнаяНакладная.ВалютаДокумента,
		|	ТИПЗНАЧЕНИЯ(РасходнаяНакладная.Ссылка),
		|	ВЫБОР
		|		КОГДА РасходнаяНакладная.Проведен
		|			ТОГДА 1
		|		КОГДА РасходнаяНакладная.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ
		|ИЗ
		|	Документ.РасходнаяНакладная КАК РасходнаяНакладная
		|ГДЕ
		|	(РасходнаяНакладная.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийРасходнаяНакладная.ВозвратПоставщику)
		|			ИЛИ РасходнаяНакладная.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийРасходнаяНакладная.ВозвратКомитенту)
		|			ИЛИ РасходнаяНакладная.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийРасходнаяНакладная.ВозвратИзПереработки)
		|			ИЛИ РасходнаяНакладная.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийРасходнаяНакладная.ВозвратСОтветхранения))
		|";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.РасходИзКассы) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Номер,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	&ДоговорПоУмолчанию,
		|	ДанныеДокумента.СуммаДокумента,
		|	ДанныеДокумента.ВалютаДенежныхСредств,
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка),
		|	ВЫБОР
		|		КОГДА ДанныеДокумента.Проведен
		|			ТОГДА 1
		|		КОГДА ДанныеДокумента.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ
		|ИЗ
		|	Документ.РасходИзКассы КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.РасходСоСчета) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Номер,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	&ДоговорПоУмолчанию,
		|	ДанныеДокумента.СуммаДокумента,
		|	ДанныеДокумента.ВалютаДенежныхСредств,
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка),
		|	ВЫБОР
		|		КОГДА ДанныеДокумента.Проведен
		|			ТОГДА 1
		|		КОГДА ДанныеДокумента.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ
		|ИЗ
		|	Документ.РасходСоСчета КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	Если Лев(ТекстЗапроса, 10) = "ОБЪЕДИНИТЬ" Тогда
		ТекстЗапроса = Сред(ТекстЗапроса, 14);
	КонецЕсли;
	
	Возврат ТекстЗапроса;
	
КонецФункции // ПолучитьТекстЗапросаДокументыРасчетовСПоставщиками()

// Получает запрос для выбора документов расчетов с покупателями 
// для документов "Расход со счета" и "Расход из кассы".
//
&НаСервереБезКонтекста
Функция ПолучитьТекстЗапросаДокументыРасчетовСПокупателямиСписание(ОтборПоДоговору)
	
	ТекстЗапроса = "";
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.ПоступлениеВКассу) Тогда
		ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка КАК Ссылка,
		|	ДанныеДокумента.Дата КАК Дата,
		|	ДанныеДокумента.Номер КАК Номер,
		|	ДанныеДокумента.Организация КАК Организация,
		|	ДанныеДокумента.Контрагент КАК Контрагент,
		|	&ДоговорПоУмолчанию КАК Договор,
		|	ДанныеДокумента.СуммаДокумента КАК Сумма,
		|	ДанныеДокумента.ВалютаДенежныхСредств КАК Валюта,
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка) КАК Тип,
		|	ВЫБОР
		|		КОГДА ДанныеДокумента.Проведен
		|			ТОГДА 1
		|		КОГДА ДанныеДокумента.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК СостояниеДокумента
		|ИЗ
		|	Документ.ПоступлениеВКассу КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.ПоступлениеНаСчет) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Номер,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	&ДоговорПоУмолчанию,
		|	ДанныеДокумента.СуммаДокумента,
		|	ДанныеДокумента.ВалютаДенежныхСредств,
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка),
		|	ВЫБОР
		|		КОГДА ДанныеДокумента.Проведен
		|			ТОГДА 1
		|		КОГДА ДанныеДокумента.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ
		|ИЗ
		|	Документ.ПоступлениеНаСчет КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.АктВыполненныхРабот) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Номер,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	ДанныеДокумента.Договор,
		|	ДанныеДокумента.СуммаДокумента,
		|	ДанныеДокумента.ВалютаДокумента,
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка),
		|	ВЫБОР
		|		КОГДА ДанныеДокумента.Проведен
		|			ТОГДА 1
		|		КОГДА ДанныеДокумента.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ
		|ИЗ
		|	Документ.АктВыполненныхРабот КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.Взаимозачет) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Номер,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	&ДоговорПоУмолчанию,
		|	ДанныеДокумента.СуммаРасчетов,
		|	ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка),
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка),
		|	ВЫБОР
		|		КОГДА ДанныеДокумента.Проведен
		|			ТОГДА 1
		|		КОГДА ДанныеДокумента.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ
		|ИЗ
		|	Документ.Взаимозачет КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.ЗаказПокупателя) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Номер,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	ДанныеДокумента.Договор,
		|	ДанныеДокумента.СуммаДокумента,
		|	ДанныеДокумента.ВалютаДокумента,
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка),
		|	ВЫБОР
		|		КОГДА ДанныеДокумента.Проведен
		|			ТОГДА 1
		|		КОГДА ДанныеДокумента.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ
		|ИЗ
		|	Документ.ЗаказПокупателя КАК ДанныеДокумента
		|ГДЕ
		|	ДанныеДокумента.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийЗаказПокупателя.ЗаказНаряд)";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.ОтчетКомиссионера) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Номер,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	ДанныеДокумента.Договор,
		|	ДанныеДокумента.СуммаДокумента,
		|	ДанныеДокумента.ВалютаДокумента,
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка),
		|	ВЫБОР
		|		КОГДА ДанныеДокумента.Проведен
		|			ТОГДА 1
		|		КОГДА ДанныеДокумента.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ
		|ИЗ
		|	Документ.ОтчетКомиссионера КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.ОтчетОПереработке) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Номер,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	ДанныеДокумента.Договор,
		|	ДанныеДокумента.СуммаДокумента,
		|	ДанныеДокумента.ВалютаДокумента,
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка),
		|	ВЫБОР
		|		КОГДА ДанныеДокумента.Проведен
		|			ТОГДА 1
		|		КОГДА ДанныеДокумента.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ
		|ИЗ
		|	Документ.ОтчетОПереработке КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.ПередачаВА) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Номер,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	ДанныеДокумента.Договор,
		|	ДанныеДокумента.СуммаДокумента,
		|	ДанныеДокумента.ВалютаДокумента,
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка),
		|	ВЫБОР
		|		КОГДА ДанныеДокумента.Проведен
		|			ТОГДА 1
		|		КОГДА ДанныеДокумента.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ
		|ИЗ
		|	Документ.ПередачаВА КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.ПриходнаяНакладная) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ПриходнаяНакладная.Ссылка,
		|	ПриходнаяНакладная.Дата,
		|	ПриходнаяНакладная.Номер,
		|	ПриходнаяНакладная.Организация,
		|	ПриходнаяНакладная.Контрагент,
		|	ПриходнаяНакладная.Договор,
		|	ПриходнаяНакладная.СуммаДокумента,
		|	ПриходнаяНакладная.ВалютаДокумента,
		|	ТИПЗНАЧЕНИЯ(ПриходнаяНакладная.Ссылка) КАК Поле1,
		|	ВЫБОР
		|		КОГДА ПриходнаяНакладная.Проведен
		|			ТОГДА 1
		|		КОГДА ПриходнаяНакладная.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК Поле2
		|ИЗ
		|	Документ.ПриходнаяНакладная КАК ПриходнаяНакладная
		|ГДЕ
		|	(ПриходнаяНакладная.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийПриходнаяНакладная.ВозвратОтПокупателя)
		|			ИЛИ ПриходнаяНакладная.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийПриходнаяНакладная.ВозвратОтКомиссионера)
		|			ИЛИ ПриходнаяНакладная.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийПриходнаяНакладная.ВозвратОтПереработчика)
		|			ИЛИ ПриходнаяНакладная.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийПриходнаяНакладная.ВозвратСОтветхранения))
		|";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.РасходнаяНакладная) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Номер,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	ДанныеДокумента.Договор,
		|	ДанныеДокумента.СуммаДокумента,
		|	ДанныеДокумента.ВалютаДокумента,
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка),
		|	ВЫБОР
		|		КОГДА ДанныеДокумента.Проведен
		|			ТОГДА 1
		|		КОГДА ДанныеДокумента.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ
		|ИЗ
		|	Документ.РасходнаяНакладная КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	// Эквайринг
	Если ПравоДоступа("Чтение", Метаданные.Документы.ПоступлениеНаСчет) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Номер,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	&ДоговорПоУмолчанию,
		|	ДанныеДокумента.СуммаДокумента,
		|	ДанныеДокумента.ВалютаДенежныхСредств,
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка) КАК Поле1,
		|	ВЫБОР
		|		КОГДА ДанныеДокумента.Проведен
		|			ТОГДА 1
		|		КОГДА ДанныеДокумента.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК Поле2
		|ИЗ
		|	Документ.ОперацияПоПлатежнымКартам КАК ДанныеДокумента
		|ГДЕ
		|	ДанныеДокумента.ВидОперации = ЗНАЧЕНИЕ(Перечисление.ВидыОперацийЭквайринга.ПоступлениеОплатыОтПокупателя)";
		
	КонецЕсли;
	// Конец Эквайринг
	
	Если Лев(ТекстЗапроса, 10) = "ОБЪЕДИНИТЬ" Тогда
		ТекстЗапроса = Сред(ТекстЗапроса, 14);
	КонецЕсли;
	
	Возврат ТекстЗапроса;
	
КонецФункции

// Получает запрос для выбора документов расчетов с поставщиками 
// для документов "Расход со счета" и "Расход из кассы".
//
&НаСервереБезКонтекста
Функция ПолучитьТекстЗапросаДокументыРасчетовСПоставщикамиСписание(ОтборПоДоговору)
	
	ТекстЗапроса = "";
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.ДополнительныеРасходы) Тогда
		ТекстЗапроса = "
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка КАК Ссылка,
		|	ДанныеДокумента.Дата КАК Дата,
		|	ДанныеДокумента.Номер КАК Номер,
		|	ДанныеДокумента.Организация КАК Организация,
		|	ДанныеДокумента.Контрагент КАК Контрагент,
		|	ДанныеДокумента.Договор КАК Договор,
		|	ДанныеДокумента.СуммаДокумента КАК Сумма,
		|	ДанныеДокумента.ВалютаДокумента КАК Валюта,
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка) КАК Тип,
		|	ВЫБОР
		|		КОГДА ДанныеДокумента.Проведен
		|			ТОГДА 1
		|		КОГДА ДанныеДокумента.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК СостояниеДокумента
		|ИЗ
		|	Документ.ДополнительныеРасходы КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.ПриходнаяНакладная) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Номер,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	ДанныеДокумента.Договор,
		|	ДанныеДокумента.СуммаДокумента,
		|	ДанныеДокумента.ВалютаДокумента,
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка),
		|	ВЫБОР
		|		КОГДА ДанныеДокумента.Проведен
		|			ТОГДА 1
		|		КОГДА ДанныеДокумента.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ
		|ИЗ
		|	Документ.ПриходнаяНакладная КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.РасходнаяНакладная) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Номер,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	ДанныеДокумента.Договор,
		|	ДанныеДокумента.СуммаДокумента,
		|	ДанныеДокумента.ВалютаДокумента,
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка),
		|	ВЫБОР
		|		КОГДА ДанныеДокумента.Проведен
		|			ТОГДА 1
		|		КОГДА ДанныеДокумента.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ
		|ИЗ
		|	Документ.РасходнаяНакладная КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.ОтчетКомитенту) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Номер,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	ДанныеДокумента.Договор,
		|	ДанныеДокумента.СуммаДокумента,
		|	ДанныеДокумента.ВалютаДокумента,
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка),
		|	ВЫБОР КОГДА ДанныеДокумента.Проведен ТОГДА
		|		1
		|	КОГДА ДанныеДокумента.ПометкаУдаления ТОГДА
		|		2
		|	ИНАЧЕ
		|		0
		|	КОНЕЦ
		|ИЗ
		|	Документ.ОтчетКомитенту КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.ОтчетПереработчика) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Номер,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	ДанныеДокумента.Договор,
		|	ДанныеДокумента.Сумма,
		|	ДанныеДокумента.ВалютаДокумента,
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка),
		|	ВЫБОР КОГДА ДанныеДокумента.Проведен ТОГДА
		|		1
		|	КОГДА ДанныеДокумента.ПометкаУдаления ТОГДА
		|		2
		|	ИНАЧЕ
		|		0
		|	КОНЕЦ
		|ИЗ
		|	Документ.ОтчетПереработчика КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	Если ПравоДоступа("Чтение", Метаданные.Документы.Взаимозачет) Тогда
		ТекстЗапроса = ТекстЗапроса + "ОБЪЕДИНИТЬ ВСЕ" +
		"
		|ВЫБРАТЬ
		|	ДанныеДокумента.Ссылка,
		|	ДанныеДокумента.Дата,
		|	ДанныеДокумента.Номер,
		|	ДанныеДокумента.Организация,
		|	ДанныеДокумента.Контрагент,
		|	&ДоговорПоУмолчанию,
		|	ДанныеДокумента.СуммаРасчетов,
		|	ЗНАЧЕНИЕ(Справочник.Валюты.ПустаяСсылка),
		|	ТИПЗНАЧЕНИЯ(ДанныеДокумента.Ссылка),
		|	ВЫБОР
		|		КОГДА ДанныеДокумента.Проведен
		|			ТОГДА 1
		|		КОГДА ДанныеДокумента.ПометкаУдаления
		|			ТОГДА 2
		|		ИНАЧЕ 0
		|	КОНЕЦ
		|ИЗ
		|	Документ.Взаимозачет КАК ДанныеДокумента
		|";
		
	КонецЕсли;
	
	Если Лев(ТекстЗапроса, 10) = "ОБЪЕДИНИТЬ" Тогда
		ТекстЗапроса = Сред(ТекстЗапроса, 14);
	КонецЕсли;
	
	Возврат ТекстЗапроса;
	
КонецФункции

// Получает заказ из шапки документа расчетов.
//
&НаСервереБезКонтекста
Функция ПолучитьЗаказ(Документ, ЭтоРасчетыСПокупателями)
	
	Если ЭтоРасчетыСПокупателями Тогда
		
		Если ТипЗнч(Документ) = Тип("ДокументСсылка.АктВыполненныхРабот")
			ИЛИ ТипЗнч(Документ) = Тип("ДокументСсылка.ОтчетОПереработке") Тогда
			
			Заказ = Документ.ЗаказПокупателя;
			
		ИначеЕсли (ТипЗнч(Документ) = Тип("ДокументСсылка.Взаимозачет")
			ИЛИ ТипЗнч(Документ) = Тип("ДокументСсылка.ПриходнаяНакладная")
			ИЛИ ТипЗнч(Документ) = Тип("ДокументСсылка.РасходнаяНакладная"))
			И ТипЗнч(Документ.Заказ) = Тип("ДокументСсылка.ЗаказПокупателя") Тогда
			
			Заказ = Документ.Заказ;
			
		Иначе
			
			Заказ = Документы.ЗаказПокупателя.ПустаяСсылка();
			
		КонецЕсли;
			
	Иначе
		
		Если ТипЗнч(Документ) = Тип("ДокументСсылка.ДополнительныеРасходы") Тогда
			
			Заказ = Документ.ЗаказПоставщику;
			
		ИначеЕсли (ТипЗнч(Документ) = Тип("ДокументСсылка.Взаимозачет")
			ИЛИ ТипЗнч(Документ) = Тип("ДокументСсылка.ПриходнаяНакладная")
			ИЛИ ТипЗнч(Документ) = Тип("ДокументСсылка.РасходнаяНакладная"))
			И ТипЗнч(Документ.Заказ) = Тип("ДокументСсылка.ЗаказПоставщику") Тогда
			
			Заказ = Документ.Заказ;
			
		Иначе
			
			Заказ = Документы.ЗаказПоставщику.ПустаяСсылка();
			
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Заказ;
	
КонецФункции

// Получает счет на оплату, связанный с документом расчетов.
//
&НаСервереБезКонтекста
Функция ПолучитьСчетНаОплатуПоОснованию(ДокументОснование, ЭтоРасчетыСПокупателями)

	Если ЭтоРасчетыСПокупателями Тогда
		
		СчетНаОплату = Документы.СчетНаОплату.ПустаяСсылка();
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	СчетНаОплату.Ссылка КАК СчетНаОплату
		|ИЗ
		|	Документ.СчетНаОплату КАК СчетНаОплату
		|ГДЕ
		|	СчетНаОплату.ДокументОснование = &ДокументОснование";
		
		Запрос.УстановитьПараметр("ДокументОснование", ДокументОснование);
		Выборка = Запрос.Выполнить().Выбрать();
		
		Если Выборка.Количество() = 1
			И Выборка.Следующий() Тогда
			
			СчетНаОплату = Выборка.СчетНаОплату;
			
		КонецЕсли;
		
	Иначе
		
		СчетНаОплату = Документы.СчетНаОплатуПоставщика.ПустаяСсылка();
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	СчетНаОплатуПоставщика.Ссылка КАК СчетНаОплату
		|ИЗ
		|	Документ.СчетНаОплатуПоставщика КАК СчетНаОплатуПоставщика
		|ГДЕ
		|	СчетНаОплатуПоставщика.ДокументОснование = &ДокументОснование";
		
		Запрос.УстановитьПараметр("ДокументОснование", ДокументОснование);
		Выборка = Запрос.Выполнить().Выбрать();
		
		Если Выборка.Количество() = 1
			И Выборка.Следующий() Тогда
			
			СчетНаОплату = Выборка.СчетНаОплату;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат СчетНаОплату;

КонецФункции

// Получает счет на оплату, связанный с документом расчетов.
//
&НаСервереБезКонтекста
Функция ПолучитьСчетНаОплату(Документ, Заказ, ЭтоРасчетыСПокупателями)

	Если ЭтоРасчетыСПокупателями Тогда
		
		СчетНаОплату = Документы.СчетНаОплату.ПустаяСсылка();
		
		Если ТипЗнч(Документ) = Тип("ДокументСсылка.АктВыполненныхРабот")
			ИЛИ ТипЗнч(Документ) = Тип("ДокументСсылка.ОтчетОПереработке")
			ИЛИ ТипЗнч(Документ) = Тип("ДокументСсылка.РасходнаяНакладная")
			ИЛИ (ТипЗнч(Документ) = Тип("ДокументСсылка.ЗаказПокупателя")
			И Документ.ВидОперации = Перечисления.ВидыОперацийЗаказПокупателя.ЗаказНаряд) Тогда
			
			ДокументОснование = Документ;
			ДокументОснование2 = Заказ;
		Иначе
			ДокументОснование = Заказ;
			ДокументОснование2 = Документ;
		КонецЕсли;
		
		Если Не ЗначениеЗаполнено(ДокументОснование) Тогда
			Возврат СчетНаОплату;
		КонецЕсли;
		
		СчетНаОплату = ПолучитьСчетНаОплатуПоОснованию(ДокументОснование, ЭтоРасчетыСПокупателями);
		
		Если СчетНаОПлату.Пустая() Тогда
			
			СчетНаОплату = ПолучитьСчетНаОплатуПоОснованию(ДокументОснование2, ЭтоРасчетыСПокупателями);
			
		КонецЕсли;
		
	Иначе
		
		СчетНаОплату = Документы.СчетНаОплатуПоставщика.ПустаяСсылка();
		Если Не ЗначениеЗаполнено(Заказ) Тогда
			Возврат СчетНаОплату;
		КонецЕсли;
		
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	СчетНаОплатуПоставщика.Ссылка КАК СчетНаОплату
		|ИЗ
		|	Документ.СчетНаОплатуПоставщика КАК СчетНаОплатуПоставщика
		|ГДЕ
		|	СчетНаОплатуПоставщика.ДокументОснование = &ДокументОснование";
		
		Запрос.УстановитьПараметр("ДокументОснование", Заказ);
		Выборка = Запрос.Выполнить().Выбрать();
		
		Если Выборка.Количество() = 1
			И Выборка.Следующий() Тогда
			
			СчетНаОплату = Выборка.СчетНаОплату;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат СчетНаОплату;

КонецФункции

///////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ЭтоРасчетыСПокупателями = Параметры.ЭтоРасчетыСПокупателями;
	ТипДокумента = Параметры.ТипДокумента;
	
	Контрагент = Параметры.Отбор.Контрагент;
	
	ОтборПоДоговору = Параметры.Отбор.Свойство("Договор");
	Если ОтборПоДоговору Тогда
		Договор = Параметры.Отбор.Договор;
	Иначе
		Договор = Справочники.ДоговорыКонтрагентов.ПустаяСсылка();
	КонецЕсли;
	
	Если ТипДокумента = Тип("ДокументСсылка.ПоступлениеНаСчет")
		ИЛИ ТипДокумента = Тип("ДокументСсылка.ПоступлениеВКассу") Тогда
		
		Если ЭтоРасчетыСПокупателями Тогда
			Список.ТекстЗапроса = ПолучитьТекстЗапросаДокументыРасчетовСПокупателямиПоступление(ОтборПоДоговору);
		Иначе
			Список.ТекстЗапроса = ПолучитьТекстЗапросаДокументыРасчетовСПоставщикамиПоступление(ОтборПоДоговору);
			Список.Параметры.УстановитьЗначениеПараметра("КонтрагентПоУмолчанию", Параметры.Отбор.Контрагент);
		КонецЕсли;
		
	Иначе
		
		Если ЭтоРасчетыСПокупателями Тогда
			Список.ТекстЗапроса = ПолучитьТекстЗапросаДокументыРасчетовСПокупателямиСписание(ОтборПоДоговору);
		Иначе
			Список.ТекстЗапроса = ПолучитьТекстЗапросаДокументыРасчетовСПоставщикамиСписание(ОтборПоДоговору);
		КонецЕсли;
		
	КонецЕсли;
	
	Список.Параметры.УстановитьЗначениеПараметра("ДоговорПоУмолчанию", Договор);
	
	// Установим формат для текущей даты: ДФ=Ч:мм
	УправлениеНебольшойФирмойСервер.УстановитьОформлениеКолонкиДата(Список);
	
КонецПроцедуры // ПриСозданииНаСервере()

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ДЕЙСТВИЯ КОМАНДНЫХ ПАНЕЛЕЙ ФОРМЫ

// Процедура вызывается при нажатии на кнопку "Выбрать".
//
&НаКлиенте
Процедура ВыбратьДокумент(Команда)
	
	ТекущиеДанные = Элементы.Список.ТекущиеДанные;
	Если ТекущиеДанные <> Неопределено Тогда
		
		ДанныеДокумента = Новый Структура;
		ДанныеДокумента.Вставить("Документ", ТекущиеДанные.Ссылка);
		ДанныеДокумента.Вставить("Договор", ТекущиеДанные.Договор);
		
		Заказ = ПолучитьЗаказ(ТекущиеДанные.Ссылка, ЭтоРасчетыСПокупателями);
		ДанныеДокумента.Вставить("Заказ", Заказ);
		
		СчетНаОплату = ПолучитьСчетНаОплату(ТекущиеДанные.Ссылка, Заказ, ЭтоРасчетыСПокупателями);
		ДанныеДокумента.Вставить("СчетНаОплату", СчетНаОплату);
		
		ОповеститьОВыборе(ДанныеДокумента);
	Иначе
		Закрыть();
	КонецЕсли;
	
КонецПроцедуры // ВыбратьДокумент()

// Процедура вызывается при нажатии на кнопку "Открыть документ".
//
&НаКлиенте
Процедура ОткрытьДокумент(Команда)
	
	СтрокаТаблицы = Элементы.Список.ТекущиеДанные;
	Если СтрокаТаблицы <> Неопределено Тогда
		ПоказатьЗначение(Неопределено,СтрокаТаблицы.Ссылка);
	КонецЕсли;
	
КонецПроцедуры // ОткрытьДокумент()

///////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ - ОБРАБОТЧИКИ СОБЫТИЙ ПОЛЕЙ ФОРМЫ

&НаКлиенте
Процедура СписокВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	ТекущиеДанные = Элементы.Список.ТекущиеДанные;
	
	ДанныеДокумента = Новый Структура;
	ДанныеДокумента.Вставить("Документ", ТекущиеДанные.Ссылка);
	ДанныеДокумента.Вставить("Договор", ТекущиеДанные.Договор);
	
	Заказ = ПолучитьЗаказ(ТекущиеДанные.Ссылка, ЭтоРасчетыСПокупателями);
	ДанныеДокумента.Вставить("Заказ", Заказ);
	
	СчетНаОплату = ПолучитьСчетНаОплату(ТекущиеДанные.Ссылка, Заказ, ЭтоРасчетыСПокупателями);
	ДанныеДокумента.Вставить("СчетНаОплату", СчетНаОплату);
	
	ОповеститьОВыборе(ДанныеДокумента);
	
КонецПроцедуры // СписокВыбор()
