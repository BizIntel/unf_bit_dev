
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// УНФ.КонтактнаяИнформация
	КонтактнаяИнформацияУНФ.ПриСозданииПриЧтенииНаСервере(ЭтотОбъект, , 15);
	// Конец УНФ.КонтактнаяИнформация
	
	Если Объект.Ссылка.Пустая() И Не ЗначениеЗаполнено(Объект.Владелец) Тогда
		Объект.Владелец = Параметры.Организация;
	КонецЕсли;
	
	Элементы.ДатаОкончания.Доступность = НЕ Объект.Актуально;
	
	УстановитьВидимостьОКУН();
	СформироватьСтрокуОКУН();
	
	Если Параметры.ОшибкиЗаполнения Тогда
		ПроверкаДанныхКлиентСервер.ВывестиСообщенияОбОшибкахЗаполнения("Объект", Параметры.ПереченьОшибок);
	КонецЕсли;
	
	
КонецПроцедуры

&НаСервере
Процедура ПередЗаписьюНаСервере(Отказ, ТекущийОбъект, ПараметрыЗаписи)
	
	КонтактнаяИнформацияУНФ.ПередЗаписьюНаСервере(ЭтотОбъект, ТекущийОбъект);
	СформироватьСтрокуНаименования(ТекущийОбъект);
	
КонецПроцедуры

&НаСервере
Процедура ПриЧтенииНаСервере(ТекущийОбъект)
	
	// УНФ.КонтактнаяИнформация
	КонтактнаяИнформацияУНФ.ПриСозданииПриЧтенииНаСервере(ЭтотОбъект, , 15);
	// Конец УНФ.КонтактнаяИнформация
	
КонецПроцедуры

&НаСервере
Процедура ОбработкаПроверкиЗаполненияНаСервере(Отказ, ПроверяемыеРеквизиты)
	// УНФ.КонтактнаяИнформация
	КонтактнаяИнформацияУНФ.ОбработкаПроверкиЗаполненияНаСервере(ЭтотОбъект, Отказ);
	// Конец УНФ.КонтактнаяИнформация
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗаписи(ПараметрыЗаписи)
	Оповестить("ЗаписьВидаДеятельностиЕНВД",Новый Структура("Организация", объект.Владелец));
КонецПроцедуры

&НаКлиенте
Процедура СсылкаЗаполненияОКУННажатие(Элемент)
	
	МассивОкунов = Новый Массив;
	Для Каждого Строка Из Объект.ЗначенияОКУН Цикл
		МассивОкунов.Добавить(Строка.ОКУН);
	КонецЦикла;
	
	МассивОкуновФ = Новый ФиксированныйМассив(МассивОкунов);
	
	ОткрытьФорму(
		"Справочник.ВидыДеятельностиЕНВД.Форма.ФормаПодбораОКУН",
		Новый Структура("МассивОКУНОВ,КодПД",
			МассивОкунов,
			ПолучитьКодВидаПредпринимательскойДеятельности(Объект.ВидПредпринимательскойДеятельности)),
		ЭтаФорма);
	
КонецПроцедуры

&НаКлиенте
Процедура ВидПредпринимательскойДеятельностиПриИзменении(Элемент)
	
	ВидДеятельностиПриИзмененииНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура КодНалоговогоОрганаПолучателяПриИзменении(Элемент)
	Если ЗначениеЗаполнено(Объект.КодНалоговогоОрганаПолучателя) Тогда
		ВыполнитьЗаполнениеСведенийОНалоговойИнспекции();
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура АктуальноПриИзменении(Элемент)
	Элементы.ДатаОкончания.Доступность = НЕ Объект.Актуально;
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаВыбора(ВыбранноеЗначение, ИсточникВыбора)
	Если ИсточникВыбора.ИмяФормы = "Справочник.ВидыДеятельностиЕНВД.Форма.ФормаПодбораОКУН" Тогда
		Объект.ЗначенияОКУН.Очистить();
		Для Каждого Элемент ИЗ ВыбранноеЗначение Цикл
			Найденные = Объект.ЗначенияОКУН.НайтиСтроки(Новый Структура("ОКУН", Элемент));
			Если Найденные.Количество() > 0 Тогда
				Продолжить;
			КонецЕсли;
			
			Объект.ЗначенияОКУН.Добавить().ОКУН = Элемент;
			
		КонецЦикла;
		СформироватьСтрокуОКУН();
		Модифицированность = Истина;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ВидДеятельностиПриИзмененииНаСервере()
	
	СформироватьСтрокуНаименования(Объект);
	УстановитьВидимостьОКУН();
	
КонецПроцедуры

&НаСервере
Процедура УстановитьВидимостьОКУН()
	
	Если Объект.ВидПредпринимательскойДеятельности.Пустая() Тогда
		Элементы.СсылкаЗаполненияОКУН.Видимость = Ложь;
	КонецЕсли;
	
	КодВида = Объект.ВидПредпринимательскойДеятельности.Код;
	
	Если КодВида = "01"
		ИЛИ КодВида = "02"
		ИЛИ КодВида = "03" Тогда
		
		Элементы.СсылкаЗаполненияОКУН.Видимость = Истина;
	Иначе
		Элементы.СсылкаЗаполненияОКУН.Видимость = Ложь;
	КонецЕсли;
	
КонецПроцедуры 

&НаСервере
Процедура СформироватьСтрокуОКУН()
	
	Если Объект.ЗначенияОКУН.Количество() = 0 Тогда
		Элементы.СсылкаЗаполненияОКУН.Заголовок = (НСтр("ru='<<Заполнить ОКУН>>'"));
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос(
	"ВЫБРАТЬ
	|	ОКУН.Код КАК Код
	|ИЗ
	|	Справочник.ОКУН КАК ОКУН
	|ГДЕ
	|	ОКУН.Ссылка В(&Ссылки)");
	
	Запрос.УстановитьПараметр("Ссылки", Объект.ЗначенияОКУН.Выгрузить().ВыгрузитьКолонку("ОКУН"));
	Выборка = Запрос.Выполнить().Выгрузить();
	РезСтрока = НСтр("ru='ОКУН: '");
	Если Выборка.Количество() < 4 Тогда
		Для Каждого Строка Из Выборка Цикл
			РезСтрока = РезСтрока+Строка.Код+"; ";
		КонецЦикла;
	Иначе
		РезСтрока = 
			СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
				НСтр("ru='Выбрано %1 кода ОКУН'"),
				Выборка.Количество() );
				
				
	КонецЕсли;
	
	Элементы.СсылкаЗаполненияОКУН.Заголовок = РезСтрока;
	
КонецПроцедуры

&НаСервереБезКонтекста
Процедура СформироватьСтрокуНаименования(Объект)
	
	
	Если Объект.КонтактнаяИнформация.Количество()>0 Тогда
		
		Представление = УправлениеКонтактнойИнформацией.ПредставлениеКонтактнойИнформации(
			Объект.КонтактнаяИнформация[0].ЗначенияПолей);
			
		
	КонецЕсли;
	
	Объект.Наименование = 
		?(ПустаяСтрока(Представление),"",Представление+", ")+
		Сред(Объект.ВидПредпринимательскойДеятельности, 6);
	
КонецПроцедуры

&НаКлиенте
Процедура ВыполнитьЗаполнениеСведенийОНалоговойИнспекции()
	
	ОписаниеОшибки = "";
	ЗаполнитьСведенияОНалоговойИнспекцииПоКоду(ОписаниеОшибки);
	
	// Обработка ошибок
	Если ЗначениеЗаполнено(ОписаниеОшибки) Тогда
		Если ОписаниеОшибки = "НеУказаныПараметрыАутентификации" Тогда
			
			ТекстВопроса = НСтр("ru='Для автоматического создания налогового органа
				|в справочнике «Контрагенты» необходимо подключиться к Интернет-поддержке
				|пользователей. Данные по налоговому органу пригодятся при уплате налогов.
				|Подключиться сейчас?'");
				
			ПараметрыВопроса = Новый Структура("ВызовПослеПодключения", "ЗаполнитьСведенияОНалоговойИнспекцииПоКоду");
			ОписаниеОповещения = Новый ОписаниеОповещения("ПодключитьИнтернетПоддержку", ЭтотОбъект, ПараметрыВопроса);
			ПоказатьВопрос(ОписаниеОповещения, ТекстВопроса, РежимДиалогаВопрос.ДаНет);
			
		Иначе
			ПоказатьПредупреждение(, ОписаниеОшибки);
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьСведенияОНалоговойИнспекцииПоКоду(ОписаниеОшибки = "")
	
	Если НЕ ЗначениеЗаполнено(Объект.КодНалоговогоОрганаПолучателя) Тогда
		Возврат;
	КонецЕсли;
	
	РеквизитыНалоговогоОргана = ДанныеГосударственныхОрганов.РеквизитыНалоговогоОрганаПоКоду(Объект.КодНалоговогоОрганаПолучателя);
	
	Если ЗначениеЗаполнено(РеквизитыНалоговогоОргана.ОписаниеОшибки) Тогда
		ОписаниеОшибки = РеквизитыНалоговогоОргана.ОписаниеОшибки;
		Возврат;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(РеквизитыНалоговогоОргана.Ссылка) Тогда
		ДанныеГосударственныхОрганов.ОбновитьДанныеГосударственногоОргана(РеквизитыНалоговогоОргана);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПодключитьИнтернетПоддержку(Ответ, ДополнительныеПараметры) Экспорт
	
	Если Ответ = КодВозвратаДиалога.Да Тогда
		
		Оповещение = Новый ОписаниеОповещения("ПодключитьИнтернетПоддержкуЗавершение", ЭтотОбъект, ДополнительныеПараметры);
		ИнтернетПоддержкаПользователейКлиент.ПодключитьИнтернетПоддержкуПользователей(Оповещение, ЭтотОбъект);
		
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ПодключитьИнтернетПоддержкуЗавершение(Результат, ДополнительныеПараметры) Экспорт
	
	Если Результат <> Неопределено Тогда
		
		Если ДополнительныеПараметры.Свойство("ВызовПослеПодключения") Тогда
			
			Если ДополнительныеПараметры.ВызовПослеПодключения = "ЗаполнитьСведенияОНалоговойИнспекцииПоКоду" Тогда
				
				ЗаполнитьСведенияОНалоговойИнспекцииПоКоду();
				
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервереБезКонтекста
Функция ПолучитьКодВидаПредпринимательскойДеятельности(Деятельность)
	Возврат ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Деятельность,"Код");
КонецФункции

&НаКлиенте
Процедура Декорация8ОбработкаНавигационнойСсылки(Элемент, НавигационнаяСсылка, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	Если ПустаяСтрока(Объект.КодНалоговогоОрганаПолучателя) Тогда
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
			НСтр("ru='Заполните код ИФНС и мы тогда сможем определить ссылку для поиска'"),
			,
			"Объект.КодНалоговогоОрганаПолучателя");
		Возврат;
	КонецЕсли;
	
	АдресСайтаНалоговой = "http://www.r"+Лев(Объект.КодНалоговогоОрганаПолучателя, 2)+".nalog.ru/help_nalog/nalz/";
	ПерейтиПоНавигационнойСсылке(АдресСайтаНалоговой);
	
	
КонецПроцедуры

#Область КонтактнаяИнформацияУНФ

&НаКлиенте
Процедура Подключаемый_КонтактнаяИнформацияНажатие(Элемент, СтандартнаяОбработка)
	
	// Передаем в списке ЗначенияПолей ОКАТО и ИФНС
	Отбор = Новый Структура("ИмяРеквизита", Элемент.Имя);
	Строки = ЭтаФорма["КонтактнаяИнформацияОписаниеДополнительныхРеквизитов"].НайтиСтроки(Отбор);
	Если Строки.Количество() > 0 Тогда
		СтрДанные = Строки[0];
		Список = СтрДанные.ЗначенияПолей;
		Список.Добавить( Объект.КодПоОКАТО,"КодОКАТО");
		Список.Добавить( Объект.КодНалоговогоОрганаПолучателя, "КодИФНС");
		СтрДанные.ЗначенияПолей = Список;
	КонецЕсли;
	
	УправлениеКонтактнойИнформациейКлиент.НачалоВыбора(ЭтаФорма, Элемент, Модифицированность, СтандартнаяОбработка);
	
	Строки = ЭтаФорма["КонтактнаяИнформацияОписаниеДополнительныхРеквизитов"].НайтиСтроки(Отбор);
	
	// получаем город
	Город = "";
	НазваниеРегиона = "";
	НаселенныйПункт = "";
	Для Каждого элСписка Из Список Цикл
		
		Если элСписка.Представление = "НазваниеРегиона" Тогда
			НазваниеРегиона = элСписка.Значение;
		ИначеЕсли элСписка.Представление = "Город" Тогда
			Город = элСписка.Значение;
		ИначеЕсли элСписка.Представление = "НаселенныйПункт" Тогда
			НаселенныйПункт = элСписка.Значение;
		КонецЕсли;
		
	КонецЦикла;
	
	// по приоритету
	Если НЕ ПустаяСтрока(НаселенныйПункт) Тогда
		Город = НаселенныйПункт;
	ИначеЕсли НЕ ПустаяСтрока(Город) Тогда
		Город = Город;
	ИначеЕсли НЕ ПустаяСтрока(НазваниеРегиона) Тогда
		Город = НазваниеРегиона;
	КонецЕсли;
	
	Объект.Наименование = 
		?(ПустаяСтрока(Город),"",Город+", ")+
		Сред(Объект.ВидПредпринимательскойДеятельности, 6);
	
	ОбновитьОтображениеДанных(); 
	
КонецПроцедуры

&НаСервере
Процедура ДобавитьКонтактнуюИнформациюСервер(ДобавляемыйВид, УстановитьВыводВФормеВсегда = Ложь) Экспорт
	
	КонтактнаяИнформацияУНФ.ДобавитьКонтактнуюИнформацию(ЭтотОбъект, ДобавляемыйВид, УстановитьВыводВФормеВсегда);
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ДействиеКИНажатие(Элемент)
	
	КонтактнаяИнформацияУНФКлиент.ДействиеКИНажатие(ЭтотОбъект, Элемент);
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ПредставлениеКИПриИзменении(Элемент)
	
	КонтактнаяИнформацияУНФКлиент.ПредставлениеКИПриИзменении(ЭтотОбъект, Элемент);
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ПредставлениеКИНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	
	КонтактнаяИнформацияУНФКлиент.ПредставлениеКИНачалоВыбора(ЭтотОбъект, Элемент, ДанныеВыбора, СтандартнаяОбработка);
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_ПредставлениеКИОчистка(Элемент, СтандартнаяОбработка)
	
	КонтактнаяИнформацияУНФКлиент.ПредставлениеКИОчистка(ЭтотОбъект, Элемент, СтандартнаяОбработка);
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_КомментарийКИПриИзменении(Элемент)
	
	КонтактнаяИнформацияУНФКлиент.КомментарийКИПриИзменении(ЭтотОбъект, Элемент);
	
КонецПроцедуры

&НаКлиенте
Процедура Подключаемый_КонтактнаяИнформацияУНФВыполнитьКоманду(Команда)
	
	КонтактнаяИнформацияУНФКлиент.ВыполнитьКоманду(ЭтотОбъект, Команда);
	
КонецПроцедуры

#КонецОбласти
