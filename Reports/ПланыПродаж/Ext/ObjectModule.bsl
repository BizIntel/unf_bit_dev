#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

Процедура ПриОпределенииНастроекОтчета(НастройкиОтчета, НастройкиВариантов) Экспорт
	
	НастройкиОтчета.ПрограммноеИзменениеФормыОтчета = Истина;
	НастройкиОтчета.ДополнительныеГруппировкиКолонок.Добавить("СценарийПланирования");
	НастройкиОтчета.ДополнительныеГруппировкиКолонок.Добавить("ОбъектПланирования");
	
	ЗаполнитьПредопределенныеВариантыОформления(НастройкиВариантов);
	УстановитьТегиВариантов(НастройкиВариантов);
	НастройкиВариантов["Основной"].Рекомендуемый = Истина;
	ДобавитьОписанияСвязанныхПолей(НастройкиВариантов);
	
КонецПроцедуры

Процедура ОбновитьНастройкиНаФорме(НастройкиОтчета, НастройкиСКД, Форма) Экспорт
	
	// Выводим заголовок поля для параметра "Измерение планирования"
	ИмяРеквизита = "";
	ОписаниеПоля = Форма.СтрокаОписанияПоляВызов("Параметр", "ИзмерениеПланирования");
	Если ОписаниеПоля <> Неопределено Тогда
		Для Каждого КлючИЗначение Из ОписаниеПоля.Элементы Цикл
			Поле = Форма.Элементы.Найти(КлючИЗначение.Ключ);
			Если Поле <> Неопределено Тогда
				Поле.ПоложениеЗаголовка = ПоложениеЗаголовкаЭлементаФормы.Верх;
				ИмяРеквизита = КлючИЗначение.Значение;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	// Установим связь параметров выбора для поля-отбора "Сценарий планирования" по полю-параметру "Измерение планирования"
	ОписаниеПоля = Форма.СтрокаОписанияПоляВызов("Фильтр", "СценарийПланирования");
	Если ОписаниеПоля <> Неопределено Тогда
		Для Каждого КлючИЗначение Из ОписаниеПоля.Элементы Цикл
			Поле = Форма.Элементы.Найти(КлючИЗначение.Ключ);
			Если Поле <> Неопределено И ТипЗнч(Поле)=Тип("ПолеФормы") И Поле.Вид=ВидПоляФормы.ПолеВвода И ИмяРеквизита <> "" Тогда
				НоваяСвязь = Новый СвязьПараметраВыбора("Отбор.ИзмерениеПланирования", ИмяРеквизита);
				НовыйМассив = Новый Массив();
				НовыйМассив.Добавить(НоваяСвязь);
				Поле.СвязиПараметровВыбора = Новый ФиксированныйМассив(НовыйМассив);
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытий

Процедура ПриКомпоновкеРезультата(ДокументРезультат, ДанныеРасшифровки, СтандартнаяОбработка)
	
	// В зависимости от параметра отчета "ИзмерениеПланирования" устанавливаем заголовок поля "ОбъектПланирования": Номенклатура / Менеджер и т.д.
	ЗначениеПараметраКД = КомпоновщикНастроек.Настройки.ПараметрыДанных.НайтиЗначениеПараметра(Новый ПараметрКомпоновкиДанных("ИзмерениеПланирования"));
	Поле = СхемаКомпоновкиДанных.НаборыДанных[0].Поля.Найти("ОбъектПланирования");
	Если ЗначениеПараметраКД <> Неопределено И Поле <> Неопределено Тогда
		Поле.Заголовок = Строка(ЗначениеПараметраКД.Значение);
	КонецЕсли;
	
	// Стандартная обработка отчета
	ОтчетыУНФ.ПриКомпоновкеРезультата(КомпоновщикНастроек, СхемаКомпоновкиДанных, ДокументРезультат, ДанныеРасшифровки, СтандартнаяОбработка);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Процедура ЗаполнитьПредопределенныеВариантыОформления(НастройкиВариантов)
	
	МассивПолейСумм = Новый Массив;
	МассивПолейКоличества = Новый Массив;
	Для Каждого ДоступноеПоле Из КомпоновщикНастроек.Настройки.ДоступныеПоляВыбора.Элементы Цикл
		Если НЕ ДоступноеПоле.Ресурс Тогда
			Продолжить;
		КонецЕсли;
		ИмяПоля = Строка(ДоступноеПоле.Поле);
		Если СтрНачинаетсяС(ИмяПоля, "Количество") Тогда
			МассивПолейКоличества.Добавить(ИмяПоля);
		ИначеЕсли СтрНачинаетсяС(ИмяПоля, "Сумма") Тогда
			МассивПолейСумм.Добавить(ИмяПоля);
		КонецЕсли;
	КонецЦикла;
	
	Для Каждого НастройкиТекВарианта Из НастройкиВариантов Цикл
		
		ВариантыОформления = НастройкиТекВарианта.Значение.ВариантыОформления;
		ОтчетыУНФ.ДобавитьВариантыОформленияСумм(ВариантыОформления, МассивПолейСумм);
		ОтчетыУНФ.ДобавитьВариантыОформленияКоличества(ВариантыОформления, МассивПолейКоличества);
		
	КонецЦикла;
	
КонецПроцедуры

Процедура УстановитьТегиВариантов(НастройкиВариантов)
	
	Для Каждого НастройкиТекВарианта Из НастройкиВариантов Цикл
		НастройкиТекВарианта.Значение.Теги = НСтр("ru = 'Компания,Продажи,CRM'");
	КонецЦикла;
	
КонецПроцедуры

Процедура ДобавитьОписанияСвязанныхПолей(НастройкиВариантов)
	
	Для Каждого НастройкиТекВарианта Из НастройкиВариантов Цикл
		ОтчетыУНФ.ДобавитьОписаниеПривязки(НастройкиТекВарианта.Значение.СвязанныеПоля, "Подразделение", "Справочник.СтруктурныеЕдиницы");
		ОтчетыУНФ.ДобавитьОписаниеПривязки(НастройкиТекВарианта.Значение.СвязанныеПоля, "ОбъектПланирования", "Справочник.Номенклатура");
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

ЭтоОтчетУНФ = Истина;

#КонецЕсли
